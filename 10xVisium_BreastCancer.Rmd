---
title: "10xVisium_BreastCancer"
author: "Lauren Rusnak"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Prep

```{r include=F}
library(SpatialExperiment)
library(STexampleData)
library(scran)
library(DropletUtils)
library(ggplot2)
library(ggspavis)
library(scater)
library(smoothclust)
library(stats)
library(mclust)
library(randnet)
library(R.utils)
library(tibble)
library(dplyr)
library(RColorBrewer)
```


_________________________________________________________________________


## Import Data

```{r}
dir <- file.path("C:/Users/lerus/OneDrive/Documents/BU-AB/ResearchRotation/10xVisium")
  
sample_ids <- c("Visium_Human_Breast_Cancer")
samples <- file.path(dir, sample_ids, "outs")

spe1 <- read10xVisium(samples,)

# tabulate number of spots mapped to tissue
cd <- colData(spe1)
table(
  in_tissue = cd$in_tissue, 
  sample_id = cd$sample_id)

# view available images
imgData(spe1)
```

```{r}
spe1
```


_______________________________________________________________________________



## Non-spatially aware workflow



### Normalization and Feature Selection

*Normalization*
```{r}
spe <- logNormCounts(spe1) 
assayNames(spe)
```

*Calculate highly variable genes (HVGs) and select the top HVGs*
```{r}
dec <- modelGeneVar(spe) 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```


### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs, exprs_values = "logcounts")

# UMAP on top 50 PCs -> for visualization
set.seed(123)
spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))
dim(reducedDim(spe, "UMAP"))

# update column names
colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```


### K-means clustering with 3 centers
```{r}
## 3 centers

set.seed(123)

km.3.nonspac <- kmeans(pcs, centers = 3)

table(km.3.nonspac$cluster)

# kmeans cluster assignments
km.clus3.nonspac <- km.3.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus3.nonspac)
```


#### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_nonspac_km3 <- plotSpots(spe, annotate = "label", 
          pal = "libd_layer_colors",
          point_size = 0.9)
xyplot_nonspac_km3
## feature names error probably due to only 1 rowData name - not an option in plotSpots code ##
```


#### Smoothness Metric
```{r}
nonspac.km3.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

nonspac.km3.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- nonspac.km3.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```




### K-means clustering with 4 centers
```{r}
## 4 centers

set.seed(123)

km.4.nonspac <- kmeans(pcs, centers = 4)

table(km.4.nonspac$cluster)

# kmeans cluster assignments
km.clus4.nonspac <- km.4.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus4.nonspac)
```


#### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_nonspac_km4 <- plotSpots(spe, annotate = "label", 
          pal = "libd_layer_colors",
          point_size = 0.7)
xyplot_nonspac_km4
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "libd_layer_colors",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "libd_layer_colors",
           point_size = 0.7)
```


#### Smoothness Metric
```{r}
nonspac.km4.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

nonspac.km4.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- nonspac.km4.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```



### K-means clustering with 6 centers
```{r}
## 6 centers

set.seed(123)

km.6.nonspac <- kmeans(pcs, centers = 6)

table(km.6.nonspac$cluster)

# kmeans cluster assignments
km.clus6.nonspac <- km.6.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus6.nonspac)
```


#### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_nonspac_km6 <- plotSpots(spe, annotate = "label", 
          pal = "libd_layer_colors",
          point_size = 0.7)
xyplot_nonspac_km6
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "libd_layer_colors",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "libd_layer_colors",
           point_size = 0.7)
```


#### Smoothness Metric
```{r}
nonspac.km6.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

nonspac.km4.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- nonspac.km4.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```



### K-means clustering with 8 centers
```{r}
## 8 centers

set.seed(123)

km.8.nonspac <- kmeans(pcs, centers = 8)

table(km.8.nonspac$cluster)

# kmeans cluster assignments
km.clus8.nonspac <- km.8.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.nonspac)
```


#### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_nonspac_km8 <- plotSpots(spe, annotate = "label", 
          pal = "libd_layer_colors",
          point_size = 0.7)
xyplot_nonspac_km8
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "libd_layer_colors",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "libd_layer_colors",
           point_size = 0.7)
```


#### Smoothness Metric
```{r}
nonspac.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

nonspac.km8.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- nonspac.km8.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```


#### Nonspatial SM summary
```{r}
## SM
SMs_nonspac <- matrix(c('kmeans (3 clusters)','kmeans (4 clusters)','kmeans (6 clusters)','kmeans (8 clusters)', nonspac.km3.sm$mean_discordant, nonspac.km4.sm$mean_discordant, nonspac.km6.sm$mean_discordant, nonspac.km8.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_nonspac) <- c('Clustering Method', 'Non-spatial')

SMs_nonspac_df <- as.data.frame(SMs_nonspac)

SMs_nonspac_df
```



_________________________________________________________________________


## Spatially-Aware Workflows

### Method: Uniform

```{r, include = FALSE}
# library(smoothclust)
spe <- smoothclust(spe1, method = "uniform")
```

```{r}
assayNames(spe)
```


#### Normalization and Feature Selection

*Normalization*
```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
assayNames(spe)
```

*Calculate highly variable genes (HVGs) and select the top HVGs*
```{r}
dec <- modelGeneVar(spe, assay.type = "logcounts") 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```


#### Dimensionality reduction
```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs, exprs_values = "logcounts")

# UMAP on top 50 PCs -> for visualization
set.seed(123)
spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))
dim(reducedDim(spe, "UMAP"))

# update column names
colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```


#### Clustering
```{r}
n_clusters <- 15
# Initialize total within sum of squares error: wss
wss <- numeric(n_clusters)
set.seed(123)

# Look over 1 to n possible clusters
for (i in 1:n_clusters) {
  # Fit the model: km.out
  km.out <- kmeans(pcs, centers = i, nstart = 20)
  # Save the within cluster sum of squares
  wss[i] <- km.out$tot.withinss
}

# Produce a scree plot
wss_df <- tibble(clusters = 1:n_clusters, wss = wss)
 
scree_plot <- ggplot(wss_df, aes(x = clusters, y = wss, group = 1)) +
    geom_point(point_size = 4)+
    geom_line() +
    xlab('Number of clusters') +
    scale_x_continuous(breaks = c(2,4,6,8,10,12,14,16))
scree_plot
```


##### K-means clustering with 3 centers
```{r}
## 3 centers

set.seed(123)

km.3.uni <- kmeans(pcs, centers = 3)

table(km.3.uni$cluster)

# kmeans cluster assignments
km.clus3.uni <- km.3.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus3.uni)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_uni_km3 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=3,name="Dark2"),
          point_size = 0.7)
xyplot_uni_km3
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=3,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=3,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
uni.km3.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

uni.km3.sm$mean_discordant
```



##### K-means clustering with 4 centers
```{r}
## 4 centers

set.seed(123)

km.4.uni <- kmeans(pcs, centers = 4)

table(km.4.uni$cluster)

# kmeans cluster assignments
km.clus4.uni <- km.4.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus4.uni)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_uni_km4 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=4,name="Dark2"),
          point_size = 0.7)
xyplot_uni_km4
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=4,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=4,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
uni.km4.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

uni.km4.sm$mean_discordant
```



##### K-means clustering with 6 centers
```{r}
## 6 centers

set.seed(123)

km.6.uni <- kmeans(pcs, centers = 6)

table(km.6.uni$cluster)

# kmeans cluster assignments
km.clus6.uni <- km.6.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus6.uni)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_uni_km6 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=6,name="Dark2"),
          point_size = 0.7)
xyplot_uni_km6
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=6,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=6,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
uni.km6.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

uni.km6.sm$mean_discordant
```



##### K-means clustering with 8 centers
```{r}
## 8 centers

set.seed(123)

km.8.uni <- kmeans(pcs, centers = 8)

table(km.8.uni$cluster)

# kmeans cluster assignments
km.clus8.uni <- km.8.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.uni)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_uni_km8 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=8,name="Dark2"),
          point_size = 0.7)
xyplot_uni_km8
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=8,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=8,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
uni.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

uni.km8.sm$mean_discordant
```


#### Uniform SM summary
```{r}
## SM
SMs_uni <- matrix(c('kmeans (3 clusters)','kmeans (4 clusters)','kmeans (6 clusters)','kmeans (8 clusters)', uni.km3.sm$mean_discordant, uni.km4.sm$mean_discordant, uni.km6.sm$mean_discordant, uni.km8.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_uni) <- c('Clustering Method', 'Uniform')

SMs_uni_df <- as.data.frame(SMs_uni)

SMs_uni_df
```


________________________________________________________________________


### Method: Kernel, bandwidth= 0.02

```{r, include = FALSE}
# library(smoothclust)
spe <- smoothclust(spe1, method = "kernel", bandwidth = 0.02)
```

```{r}
assayNames(spe)
```


#### Normalization and Feature Selection

*Normalization*
```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
assayNames(spe)
```

*Calculate highly variable genes (HVGs) and select the top HVGs*
```{r}
dec <- modelGeneVar(spe) 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```


#### Dimensionality reduction
```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs, exprs_values = "logcounts")

# UMAP on top 50 PCs -> for visualization
set.seed(123)
spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))
dim(reducedDim(spe, "UMAP"))

# update column names
colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```


#### Clustering

##### K-means clustering with 3 centers
```{r}
## 3 centers

set.seed(123)

km.3.kern02 <- kmeans(pcs, centers = 3)

table(km.3.kern02$cluster)

# kmeans cluster assignments
km.clus3.kern02 <- km.3.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus3.kern02)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.02_km3 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=3,name="Dark2"),
          point_size = 0.7)
xyplot_kern.02_km3
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=3,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=3,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.02.km3.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.02.km3.sm$mean_discordant
```



##### K-means clustering with 4 centers
```{r}
## 4 centers

set.seed(123)

km.4.kern02 <- kmeans(pcs, centers = 4)

table(km.4.kern02$cluster)

# kmeans cluster assignments
km.clus4.kern02 <- km.4.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus4.kern02)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.02_km4 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=4,name="Dark2"),
          point_size = 0.7)
xyplot_kern.02_km4
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=4,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=4,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.02.km4.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.02.km4.sm$mean_discordant
```


##### K-means clustering with 6 centers
```{r}
## 6 centers

set.seed(123)

km.6.kern02 <- kmeans(pcs, centers = 6)

table(km.6.kern02$cluster)

# kmeans cluster assignments
km.clus6.kern02 <- km.6.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus6.kern02)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.02_km6 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=6,name="Dark2"),
          point_size = 0.7)
xyplot_kern.02_km6
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=6,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=6,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.02.km6.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.02.km6.sm$mean_discordant
```



##### K-means clustering with 8 centers
```{r}
## 8 centers

set.seed(123)

km.8.kern02 <- kmeans(pcs, centers = 8)

table(km.8.kern02$cluster)

# kmeans cluster assignments
km.clus8.kern02 <- km.8.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.kern02)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.02_km8 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=8,name="Dark2"),
          point_size = 0.7)
xyplot_kern.02_km8
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=8,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=8,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.02.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.02.km8.sm$mean_discordant
```


#### Kernel, 0.02 SM summary
```{r}
## SM
SMs_kern.02 <- matrix(c('kmeans (3 clusters)','kmeans (4 clusters)','kmeans (6 clusters)','kmeans (8 clusters)', kern.02.km3.sm$mean_discordant, kern.02.km4.sm$mean_discordant, kern.02.km6.sm$mean_discordant, kern.02.km8.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.02) <- c('Clustering Method', 'Kernel, 0.02')

SMs_kern.02_df <- as.data.frame(SMs_kern.02)

SMs_kern.02_df
```


____________________________________________________________________________


### Method: Kernel, bandwidth= 0.05

```{r, include = FALSE}
# library(smoothclust)
spe <- smoothclust(spe1, method = "kernel", bandwidth = 0.05)
```

```{r}
assayNames(spe)
```


#### Normalization and Feature Selection

*Normalization*
```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
assayNames(spe)
```

*Calculate highly variable genes (HVGs) and select the top HVGs*
```{r}
dec <- modelGeneVar(spe) 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```


#### Dimensionality reduction
```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs, exprs_values = "logcounts")

# UMAP on top 50 PCs -> for visualization
set.seed(123)
spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))
dim(reducedDim(spe, "UMAP"))

# update column names
colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```


#### Clustering

##### K-means clustering with 3 centers
```{r}
## 3 centers

set.seed(123)

km.3.kern05 <- kmeans(pcs, centers = 3)

table(km.3.kern05$cluster)

# kmeans cluster assignments
km.clus3.kern05 <- km.3.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus3.kern05)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.05_km3 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=3,name="Dark2"),
          point_size = 0.7)
xyplot_kern.05_km3
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=3,name="Dark2"),,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=3,name="Dark2"),,
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.05.km3.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.05.km3.sm$mean_discordant
```



##### K-means clustering with 4 centers
```{r}
## 4 centers

set.seed(123)

km.4.kern05 <- kmeans(pcs, centers = 4)

table(km.4.kern05$cluster)

# kmeans cluster assignments
km.clus4.kern05 <- km.4.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus4.kern05)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.05_km4 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=4,name="Dark2"),,
          point_size = 0.9)
xyplot_kern.05_km4
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=4,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=4,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.05.km4.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.05.km4.sm$mean_discordant
```



##### K-means clustering with 6 centers
```{r}
## 6 centers

set.seed(123)

km.6.kern05 <- kmeans(pcs, centers = 6)

table(km.6.kern05$cluster)

# kmeans cluster assignments
km.clus6.kern05 <- km.6.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus6.kern05)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.05_km6 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=6,name="Dark2"),
          point_size = 0.9)
xyplot_kern.05_km6
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=6,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=6,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.05.km6.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.05.km6.sm$mean_discordant
```



##### K-means clustering with 8 centers
```{r}
## 8 centers

set.seed(123)

km.8.kern05 <- kmeans(pcs, centers = 8)

table(km.8.kern05$cluster)

# kmeans cluster assignments
km.clus8.kern05 <- km.8.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.kern05)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.05_km8 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=8,name="Dark2"),
          point_size = 0.7)
xyplot_kern.05_km8
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=8,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=8,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.05.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.05.km8.sm$mean_discordant
```


#### Kernel, 0.05 SM summary
```{r}
## SM
SMs_kern.05 <- matrix(c('kmeans (3 clusters)','kmeans (4 clusters)','kmeans (6 clusters)','kmeans (8 clusters)', kern.05.km3.sm$mean_discordant, kern.05.km4.sm$mean_discordant, kern.05.km6.sm$mean_discordant, kern.05.km8.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.05) <- c('Clustering Method', 'Kernel, 0.05')

SMs_kern.05_df <- as.data.frame(SMs_kern.05)

SMs_kern.05_df
```


_____________________________________________________________________________


### Method: Kernel, bandwidth= 0.08

```{r, include = FALSE}
# library(smoothclust)
spe <- smoothclust(spe1, method = "kernel", bandwidth = 0.08)
```

```{r}
assayNames(spe)
```


#### Normalization and Feature Selection

*Normalization*
```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
assayNames(spe)
```

*Calculate highly variable genes (HVGs) and select the top HVGs*
```{r}
dec <- modelGeneVar(spe) 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```


#### Dimensionality reduction
```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs, exprs_values = "logcounts")

# UMAP on top 50 PCs -> for visualization
set.seed(123)
spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))
dim(reducedDim(spe, "UMAP"))

# update column names
colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```


#### Clustering

##### K-means clustering with 3 centers
```{r}
## 3 centers

set.seed(123)

km.3.kern08 <- kmeans(pcs, centers = 3)

table(km.3.kern08$cluster)

# kmeans cluster assignments
km.clus3.kern08 <- km.3.kern08$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus3.kern08)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.08_km3 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=3,name="Dark2"),
          point_size = 0.9)
xyplot_kern.08_km3
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=3,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=3,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.08.km3.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.08.km3.sm$mean_discordant
```



##### K-means clustering with 4 centers
```{r}
## 4 centers

set.seed(123)

km.4.kern08 <- kmeans(pcs, centers = 4)

table(km.4.kern08$cluster)

# kmeans cluster assignments
km.clus4.kern08 <- km.4.kern08$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus4.kern08)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.08_km4 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=4,name="Dark2"),
          point_size = 0.9)
xyplot_kern.08_km4
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=4,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=4,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.08.km4.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.08.km4.sm$mean_discordant
```



##### K-means clustering with 6 centers
```{r}
## 6 centers

set.seed(123)

km.6.kern08 <- kmeans(pcs, centers = 6)

table(km.6.kern08$cluster)

# kmeans cluster assignments
km.clus6.kern08 <- km.6.kern08$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus6.kern08)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.08_km6 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=6,name="Dark2"),
          point_size = 0.9)
xyplot_kern.08_km6
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=6,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=6,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.08.km6.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.08.km6.sm$mean_discordant
```



##### K-means clustering with 8 centers
```{r}
## 8 centers

set.seed(123)

km.8.kern08 <- kmeans(pcs, centers = 8)

table(km.8.kern08$cluster)

# kmeans cluster assignments
km.clus8.kern08 <- km.8.kern08$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.kern08)
```


###### Visualization
```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.08_km8 <- plotSpots(spe, annotate = "label", 
          pal = brewer.pal(n=8,name="Dark2"),
          point_size = 0.7)
xyplot_kern.08_km8
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = brewer.pal(n=8,name="Dark2"),
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = brewer.pal(n=8,name="Dark2"),
           point_size = 0.7)
```


###### Smoothness Metric
```{r}
kern.08.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.08.km8.sm$mean_discordant
```


#### Kernel, 0.08 SM summary
```{r}
## SM
SMs_kern.08 <- matrix(c('kmeans (3 clusters)','kmeans (4 clusters)','kmeans (6 clusters)','kmeans (8 clusters)', kern.08.km3.sm$mean_discordant, kern.08.km4.sm$mean_discordant, kern.08.km6.sm$mean_discordant, kern.08.km8.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.08) <- c('Clustering Method', 'Kernel, 0.08')

SMs_kern.08_df <- as.data.frame(SMs_kern.08)

SMs_kern.08_df
```



### Smoothness Metric Summary

```{r}
SMs_list <- list(SMs_nonspac_df, SMs_uni_df, SMs_kern.02_df, SMs_kern.05_df, SMs_kern.08_df)
SM_cancer <- Reduce(function(x, y) merge(x, y, ), SMs_list)

cols <- c(2:6)
SM_cancer[ , cols] <- apply(SM_cancer[ , cols,drop=F], 2,           
                    function(x) as.numeric(as.character(x)))

is.num <- sapply(SM_cancer, is.numeric)
SM_cancer[is.num] <- lapply(SM_cancer[is.num], round, 4)

SM_cancer
```




### Compositional Analysis

```{r}
library(reshape)
```


#### Uniform 6 Clusters

*8 Nonspatial clusters*
```{r}
length(km.clus6.uni)
length(km.clus8.nonspac)

# check cluster frequencies
table(km.clus6.uni)
table(km.clus8.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus6.uni))
kmeans_labels <- sort(unique(km.clus8.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus6.uni)
kmeans_clus <- as.factor(km.clus8.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}
res
rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
df
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots within a smoothclust region") +
  scale_fill_manual(values=c("#F0027F", "#377EB8", "#4DAF4A", "#984EA3", 
        "#FFD700", "#FF7F00", "#1A1A1A", "#666666")) +
  scale_x_continuous(breaks=c(1:6)) +
  theme_bw()
```


```{r}
gridExtra::grid.arrange(
  (xyplot_nonspac_km8 + labs(title="Non-spatial")),
  (xyplot_uni_km6 + labs(title="Spatial - uniform")),
  ncol=2)
```



_____________________________________________________________________



#### Kernel, bandwidth = 0.02, 6 Clusters

*8 Nonspatial clusters*
```{r}
length(km.clus6.kern02)
length(km.clus8.nonspac)

# check cluster frequencies
table(km.clus6.kern02)
table(km.clus8.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus6.kern02))
kmeans_labels <- sort(unique(km.clus8.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus6.kern02)
kmeans_clus <- as.factor(km.clus8.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}
res
rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
head(df)
```



```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_fill_manual(values=c("#F0027F", "#377EB8", "#4DAF4A", "#984EA3", 
        "#FFD700", "#FF7F00", "#1A1A1A", "#666666")) +
  scale_x_continuous(breaks=c(1:6)) +
  theme_bw()
```


```{r}
gridExtra::grid.arrange(
  (xyplot_nonspac_km8 + labs(title="Non-spatial")),
  (xyplot_kern.02_km6 + labs(title="Spatial - kernel (0.02)")),
  ncol=2)
```



#### Kernel, bandwidth=0.05, 6 Clusters

*8 Nonspatial clusters*
```{r}
length(km.clus6.kern05)
length(km.clus8.nonspac)

# check cluster frequencies
table(km.clus6.kern05)
table(km.clus8.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus6.kern05))
kmeans_labels <- sort(unique(km.clus8.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus6.kern05)
kmeans_clus <- as.factor(km.clus8.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}
res
rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
head(df)
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_fill_manual(values=c("#F0027F", "#377EB8", "#4DAF4A", "#984EA3", 
        "#FFD700", "#FF7F00", "#1A1A1A", "#666666")) +
  scale_x_continuous(breaks=c(1:6)) +
  theme_bw()
```


```{r}
gridExtra::grid.arrange(
  (xyplot_nonspac_km8 + labs(title="Non-spatial")),
  (xyplot_kern.05_km6 + labs(title="Spatial - kernel (0.05)")),
  ncol=2)
```


#### Kernel, bandwidth=0.08, 6 Clusters

*8 Nonspatial clusters*
```{r}
length(km.clus6.kern08)
length(km.clus8.nonspac)

# check cluster frequencies
table(km.clus6.kern08)
table(km.clus8.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus6.kern08))
kmeans_labels <- sort(unique(km.clus8.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus6.kern08)
kmeans_clus <- as.factor(km.clus8.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}
res
rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
head(df)
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots /nwithin a smoothclust region") +
  scale_fill_manual(values=c("#F0027F", "#377EB8", "#4DAF4A", "#984EA3", 
        "#FFD700", "#FF7F00", "#1A1A1A", "#666666")) +
  scale_x_continuous(breaks=c(1:6)) + 
  theme_bw()
```


```{r}
gridExtra::grid.arrange(
  xyplot_nonspac_km8,
  xyplot_kern.08_km6,
  ncol=2)
```

Kernel, bandwidth=0.08, 4 Clusters

*8 Nonspatial clusters*
```{r}
length(km.clus4.kern08)
length(km.clus8.nonspac)

# check cluster frequencies
table(km.clus4.kern08)
table(km.clus8.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus4.kern08))
kmeans_labels <- sort(unique(km.clus8.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus4.kern08)
kmeans_clus <- as.factor(km.clus8.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}
res
rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
head(df)
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_fill_manual(values=c("#F0027F", "#377EB8", "#4DAF4A", "#984EA3", 
        "#FFD700", "#FF7F00", "#1A1A1A", "#666666")) +
  scale_x_continuous(breaks=c(1:6)) + 
  theme_bw()
```


```{r}
gridExtra::grid.arrange(
  xyplot_nonspac_km8,
  xyplot_kern.08_km4,
  ncol=2)
```
