---
title: "10x Genomics Xenium Mouse Brain"
author: "Lauren Rusnak"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Prep

```{r include=F}
library(MoleculeExperiment)
library(SpatialExperiment)
library(STexampleData)
library(scran)
library(ggplot2)
library(ggspavis)
library(scater)
library(smoothclust)
library(stats)
library(mclust)
library(randnet)
library(R.utils)
library(tibble)
library(dplyr)
library(pals)
library(reshape)
```

Palette
```{r}
pal1 <- as.vector(alphabet(n=20))
```



## Import Data

```{r}
# Create molecule experiment object
setwd("C:/Users/lerus/OneDrive/Documents/BU-AB/ResearchRotation")
baseDir <- getwd()
dataDir <- file.path(baseDir,"10xXenium")

me <- readXenium(dataDir, keepCols = "essential") # takes about 3 minutes
me
```

```{r}
# transform into spatial experiment object
spe1 <- countMolecules(me)
spe1
```
- takes ~10-15 minuts


## Non-spatially aware workflow


### Normalization

```{r}
spe <- logNormCounts(spe1) 
spe
```

### Dimensionality Reduction
```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```


### Non-spatial Clustering


#### K means

##### 5 Clusters

```{r}

set.seed(123)

km.5.nonspac <- kmeans(pcs, centers = 5)

table(km.5.nonspac$cluster)

# kmeans cluster assignments
km.clus5.nonspac <- km.5.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5.nonspac)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_nonspac_km5 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size=0.1) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
xyplot_nonspac_km5 
```


###### Smoothness Metric

```{r}
nonspac.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
nonspac.km5.sm$mean_discordant
```

*Smoothness Metric Plot*
```{r}
SM <- nonspac.km5.sm$n_discordant
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = SM)) +
  geom_point(alpha = 0.2, size=0.1) +
  scale_color_gradient(low = "gray50", high = "red1") +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```




##### 10 Clusters

```{r}

set.seed(123)

km.10.nonspac <- kmeans(pcs, centers = 10)

table(km.10.nonspac$cluster)

# kmeans cluster assignments
km.clus10.nonspac <- km.10.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.nonspac)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_nonspac_km10 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size = 0.1) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
xyplot_nonspac_km10
```


###### Smoothness Metric

```{r}
nonspac.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
nonspac.km10.sm$mean_discordant
```


*Smoothness Metric Plot*
```{r}
SM <- nonspac.km10.sm$n_discordant
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = SM)) +
  geom_point(alpha = 0.2, size=0.1) +
  scale_color_gradient(low = "gray", high = "red1") +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```



##### 15 Clusters

```{r}

set.seed(123)

km.15.nonspac <- kmeans(pcs, centers = 15)

table(km.15.nonspac$cluster)

# kmeans cluster assignments
km.clus15.nonspac <- km.15.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15.nonspac)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_nonspac_km15 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size = 0.1) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
xyplot_nonspac_km15
```


###### Smoothness Metric

```{r}
nonspac.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
nonspac.km15.sm$mean_discordant
```



##### 20 Clusters

```{r}
set.seed(123)

km.20.nonspac <- kmeans(pcs, centers = 20)

table(km.20.nonspac$cluster)

# kmeans cluster assignments
km.clus20.nonspac <- km.20.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20.nonspac)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_nonspac_km20 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size = 0.1) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
xyplot_nonspac_km20
```


###### Smoothness Metric

```{r}
nonspac.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
nonspac.km20.sm$mean_discordant
```


##### Summary

```{r}
## Smoothness Metric
SMs_nonspac <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', nonspac.km5.sm$mean_discordant, nonspac.km10.sm$mean_discordant, nonspac.km15.sm$mean_discordant, nonspac.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_nonspac) <- c('Clustering Method', 'Non-Spatial')

SMs_nonspac_df <- as.data.frame(SMs_nonspac)

SMs_nonspac_df
```

___________________________________________________________________
___________________________________________________________________



### Spatially-aware clustering 

#### Method: Uniform

```{r}
# library(smoothclust)
spe <- smoothclust(spe1, method = "uniform")
assayNames(spe)
```
  -> takes over an hour?
  
  

##### Normalization

```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
spe
```



##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```

```{r}
# UMAP
set.seed(123)

spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "UMAP"))

colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

```



##### K-means clustering 

###### 5 Clusters

```{r}

set.seed(123)

km.5.uni <- kmeans(pcs, centers = 5)

table(km.5.uni$cluster)

# kmeans cluster assignments
km.clus5.uni <- km.5.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5.uni)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = pal1,
           point_size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = pal1,
           point_size = 0.5)
```


*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_uni_km5 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.3) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank())
xyplot_uni_km5
```


####### Smoothness Metric

```{r}
uni.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
uni.km5.sm$mean_discordant
```


________________________________________________________________________


###### 10 Clusters

```{r}

set.seed(123)

km.10.uni <- kmeans(pcs, centers = 10)

table(km.10.uni$cluster)

# kmeans cluster assignments
km.clus10.uni <- km.10.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.uni)
```

####### **Visualization**


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = pal1,
           point_size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = pal1,
           point_size = 0.5)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_uni_km10 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.3) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_uni_km10
```


####### Smoothness Metric

```{r}
uni.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
uni.km10.sm$mean_discordant
```

*Smoothness Metric Plot*
```{r}
SM <- uni.km10.sm$n_discordant
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = SM)) +
  geom_point(alpha = 0.7, size=0.1) +
  scale_color_gradient(low = "gray", high = "red1") +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


_____________________________________________________________________


###### 15 Clusters

```{r}

set.seed(123)

km.15.uni <- kmeans(pcs, centers = 15)

table(km.15.uni$cluster)

# kmeans cluster assignments
km.clus15.uni <- km.15.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15.uni)
```

####### **Visualization**

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_uni_km15 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size=0.1) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank())
xyplot_uni_km15
```



####### Smoothness Metric

```{r}
uni.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
uni.km15.sm$mean_discordant
```


________________________________________________________________________


###### 20 Clusters

```{r}

set.seed(123)

km.20.uni <- kmeans(pcs, centers = 20)

table(km.20.uni$cluster)

# kmeans cluster assignments
km.clus20.uni <- km.20.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20.uni)
```


####### **Visualization**

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_uni_km20 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size = 0.1) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank())
xyplot_uni_km20
```


####### Smoothness Metric

```{r}
uni.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
uni.km20.sm$mean_discordant
```


_______________________________________________________________

##### Summary

```{r}
## Smoothness Metric
SMs_uni <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', uni.km5.sm$mean_discordant, uni.km10.sm$mean_discordant, uni.km15.sm$mean_discordant, uni.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_uni) <- c('Clustering Method', 'Uniform')

SMs_uni_df <- as.data.frame(SMs_uni)

SMs_uni_df
```





__________________________________________________________________
__________________________________________________________________



### Sub sample

```{r}
idx <- 1:ncol(spe1)
set.seed(123)
idx_keep <- sample(idx, ncol(spe1)/10)
spe_sub <- spe1[, idx_keep]
dim(spe_sub)
```

#### Non-spatially aware workflow

##### Normalization

```{r}
spe <- logNormCounts(spe_sub) 
spe
```


##### Dimensionality Reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```


##### Clustering on subsample 

##### Graph-based
*Slow and ~memory-intensive*
```{r}
set.seed(123)
k <- 30
g <- buildSNNGraph(spe, k = k, use.dimred="PCA")
g_walk <- igraph::cluster_walktrap(g)
clus <- g_walk$membership
table(clus)
```

*X-Y  Spatial Plot*
```{r}
colLabels(spe) <- factor(clus)
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```

####### Smoothness Metric

```{r}
sub.graph.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
sub.graph.sm$mean_discordant
```


##### k-means

###### 5 Clusters

```{r}

set.seed(123)

km.5.nonspac_sub <- kmeans(pcs, centers = 5)

table(km.5.nonspac_sub$cluster)

# kmeans cluster assignments
km.clus5.nonspac_sub <- km.5.nonspac_sub$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5.nonspac_sub)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_nonspac.sub_km5 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_nonspac.sub_km5
```


####### Smoothness Metric

```{r}
sub.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
sub.km5.sm$mean_discordant
```

*X-Y  Spatial Plot*
```{r}
SM <- sub.km5.sm$n_discordant
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = SM)) +
  geom_point(alpha = 0.5, size=1) +
  scale_color_gradient(low = "gray50", high = "red1") +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


__________________________________________________


###### 10 Clusters

```{r}
set.seed(123)

km.10.nonspac_sub <- kmeans(pcs, centers = 10)

table(km.10.nonspac_sub$cluster)

# kmeans cluster assignments
km.clus10.nonspac_sub <- km.10.nonspac_sub$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.nonspac_sub)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_nonspac.sub_km10 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
xyplot_nonspac.sub_km10
```


####### Smoothness Metric

```{r}
sub.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
sub.km10.sm$mean_discordant
```

*Smoothness Metric Plot*
```{r}
SM <- sub.km10.sm$n_discordant
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = SM)) +
  geom_point(alpha = 0.5, size=1) +
  scale_color_gradient(low = "gray", high = "red1") +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```



_____________________________________________________________


###### 15 Clusters

```{r}

set.seed(123)

km.15.nonspac_sub <- kmeans(pcs, centers = 15)

table(km.15.nonspac_sub$cluster)

# kmeans cluster assignments
km.clus15.nonspac_sub <- km.15.nonspac_sub$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15.nonspac_sub)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_nonspac.sub_km15 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_nonspac.sub_km15
```


####### Smoothness Metric

```{r}
sub.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
sub.km15.sm$mean_discordant
```


__________________________________________________________


###### 20 Clusters

```{r}
set.seed(123)

km.20.nonspac_sub <- kmeans(pcs, centers = 20)

table(km.20.nonspac_sub$cluster)

# kmeans cluster assignments
km.clus20.nonspac_sub <- km.20.nonspac_sub$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20.nonspac_sub)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_nonspac.sub_km20 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_nonspac.sub_km20
```



####### Smoothness Metric

```{r}
sub.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
sub.km20.sm$mean_discordant
```

_______________________________________________________________


##### Summary

```{r}
## Smoothness Metric
SMs_sub <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', sub.km5.sm$mean_discordant, sub.km10.sm$mean_discordant, sub.km15.sm$mean_discordant, sub.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_sub) <- c('Clustering Method', 'Subsample Non-Spatial')

SMs_sub_df <- as.data.frame(SMs_sub)

SMs_sub_df
```





_______________________________________________________________________
_______________________________________________________________________



#### Method: Kernel, bandwidth = 0.02

```{r}
# library(smoothclust)
spe <- smoothclust(spe_sub, method = "kernel", bandwidth = 0.02)
assayNames(spe)
```



##### Normalization

```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
spe
```




##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```

```{r}
# UMAP
set.seed(123)

spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "UMAP"))

colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

```



##### K-means clustering 


###### 5 Clusters

```{r}

set.seed(123)

km.5.kern02 <- kmeans(pcs, centers = 5)

table(km.5.kern02$cluster)

# kmeans cluster assignments
km.clus5.kern02 <- km.5.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5.kern02)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = pal1,
           point_size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = pal1,
           point_size = 0.5)
```


*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern02_km5 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.8) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern02_km5 
```


####### Smoothness Metric

```{r}
kern02.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)

kern02.km5.sm$mean_discordant
```

*X-Y  Spatial Plot*
```{r}
SM <- kern02.km5.sm$n_discordant
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = SM)) +
  geom_point(alpha = 0.5, size=1) +
  scale_color_gradient(low = "gray50", high = "red1") +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```



__________________________________________________________________


###### 10 Clusters

```{r}

set.seed(123)

km.10.kern02 <- kmeans(pcs, centers = 10)

table(km.10.kern02$cluster)

# kmeans cluster assignments
km.clus10.kern02 <- km.10.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.kern02)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = pal1,
           point_size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = pal1,
           point_size = 0.5)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern02_km10 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.8) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern02_km10
```


####### Smoothness Metric

```{r}
kern02.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
kern02.km10.sm$mean_discordant
```


_____________________________________________________________


###### 15 Clusters

```{r}

set.seed(123)

km.15.kern02 <- kmeans(pcs, centers = 15)

table(km.15.kern02$cluster)

# kmeans cluster assignments
km.clus15.kern02 <- km.15.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15.kern02)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern02_km15 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  scale_color_manual(values= pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern02_km15
```


####### Smoothness Metric

```{r}
kern02.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
kern02.km15.sm$mean_discordant
```


__________________________________________________________


###### 20 Clusters

```{r}

set.seed(123)

km.20.kern02 <- kmeans(pcs, centers = 20)

table(km.20.kern02$cluster)

# kmeans cluster assignments
km.clus20.kern02 <- km.20.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20.kern02)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern02_km20 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.5, size=0.7) +
  theme_bw() +
  scale_color_manual(values = pal1) + 
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern02_km20
```



####### Smoothness Metric

```{r}
kern02.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
kern02.km20.sm$mean_discordant
```


_______________________________________________________________

##### Summary

```{r}
## Smoothness Metric
SMs_kern.02 <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', kern02.km5.sm$mean_discordant, kern02.km10.sm$mean_discordant, kern02.km15.sm$mean_discordant, kern02.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.02) <- c('Clustering Method', 'Kernel, 0.02')

SMs_kern.02_df <- as.data.frame(SMs_kern.02)

SMs_kern.02_df
```




__________________________________________________________________
__________________________________________________________________





#### Method: Kernel, bandwidth = 0.05

```{r}
# library(smoothclust)
spe <- smoothclust(spe_sub, method = "kernel", bandwidth = 0.05)
assayNames(spe)
```

  

##### Normalization

```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
spe
```



##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```

```{r}
# UMAP
set.seed(123)

spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "UMAP"))

colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

```



##### K-means clustering 

###### 5 Clusters

```{r}

set.seed(123)

km.5.kern05 <- kmeans(pcs, centers = 5)

table(km.5.kern05$cluster)

# kmeans cluster assignments
km.clus5.kern05 <- km.5.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5.kern05)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = pal1,
           point_size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = pal1,
           point_size = 0.5)
```


*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern05_km5 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.8) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern05_km5
```



####### Smoothness Metric

```{r}
kern05.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)

kern05.km5.sm$mean_discordant
```


________________________________________________________________



###### 10 Clusters

```{r}

set.seed(123)

km.10.kern05 <- kmeans(pcs, centers = 10)

table(km.10.kern05$cluster)

# kmeans cluster assignments
km.clus10.kern05 <- km.10.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.kern05)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = pal1,
           point_size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = pal1,
           point_size = 0.5)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern05_km10 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.8) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern05_km10
```



####### Smoothness Metric

```{r}
kern05.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)

kern05.km10.sm$mean_discordant
```


*Smoothness Metric Plot*
```{r}
SM <- kern05.km10.sm$n_discordant
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = SM)) +
  geom_point(alpha = 0.5, size=1) +
  scale_color_gradient(low = "gray", high = "red1") +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


_____________________________________________________________


###### 15 Clusters

```{r}

set.seed(123)

km.15.kern05 <- kmeans(pcs, centers = 15)

table(km.15.kern05$cluster)

# kmeans cluster assignments
km.clus15.kern05 <- km.15.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15.kern05)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern05_km15 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern05_km15
```


####### Smoothness Metric

```{r}
kern05.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)

kern05.km15.sm$mean_discordant
```


__________________________________________________________


###### 20 Clusters

```{r}

set.seed(123)

km.20.kern05 <- kmeans(pcs, centers = 20)

table(km.20.kern05$cluster)

# kmeans cluster assignments
km.clus20.kern05 <- km.20.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20.kern05)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern05_km20 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern05_km20
```



####### Smoothness Metric

```{r}
kern05.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)

kern05.km20.sm$mean_discordant
```


_______________________________________________________________

##### Summary

```{r}
## Smoothness Metric
SMs_kern.05 <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', kern05.km5.sm$mean_discordant, kern05.km10.sm$mean_discordant, kern05.km15.sm$mean_discordant, kern05.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.05) <- c('Clustering Method', 'Kernel, 0.05')

SMs_kern.05_df <- as.data.frame(SMs_kern.05)

SMs_kern.05_df
```




__________________________________________________________________
__________________________________________________________________



#### Method: Kernel, bandwidth = 0.08

```{r}
# library(smoothclust)
spe <- smoothclust(spe_sub, method = "kernel", bandwidth = 0.08)
assayNames(spe)
```


  
##### Normalization

```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
spe
```



##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```

```{r}
# UMAP
set.seed(123)

spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "UMAP"))

colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

```



##### K-means clustering 

###### 5 Clusters

```{r}

set.seed(123)

km.5.kern08 <- kmeans(pcs, centers = 5)

table(km.5.kern08$cluster)

# kmeans cluster assignments
km.clus5.kern08 <- km.5.kern08$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5.kern08)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = pal1,
           point_size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = pal1,
           point_size = 0.5)
```


*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern08_km5 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.8) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern08_km5
```


####### Smoothness Metric

```{r}
kern08.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)

kern08.km5.sm$mean_discordant
```


________________________________________________________________________


###### 10 Clusters

```{r}

set.seed(123)

km.10.kern08 <- kmeans(pcs, centers = 10)

table(km.10.kern08$cluster)

# kmeans cluster assignments
km.clus10.kern08 <- km.10.kern08$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.kern08)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = pal1,
           point_size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = pal1,
           point_size = 0.5)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern08_km10 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.8) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern08_km10
```




####### Smoothness Metric

```{r}
kern08.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)

kern08.km10.sm$mean_discordant
```


_____________________________________________________________


###### 15 Clusters

```{r}

set.seed(123)

km.15.kern08 <- kmeans(pcs, centers = 15)

table(km.15.kern08$cluster)

# kmeans cluster assignments
km.clus15.kern08 <- km.15.kern08$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15.kern08)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern08_km15 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern08_km15
```


####### Smoothness Metric

```{r}
kern08.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)

kern08.km15.sm$mean_discordant
```


__________________________________________________________


###### 20 Clusters

```{r}

set.seed(123)

km.20.kern08 <- kmeans(pcs, centers = 20)

table(km.20.kern08$cluster)

# kmeans cluster assignments
km.clus20.kern08 <- km.20.kern08$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20.kern08)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

xyplot_kern08_km20 <- ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  scale_color_manual(values = pal1) +
  theme(axis.text = element_blank(), axis.title = element_blank()) +
  guides(color = guide_legend(override.aes = list(size = 2)))
xyplot_kern08_km20
```



####### Smoothness Metric

```{r}
kern08.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)

kern08.km20.sm$mean_discordant
```

_______________________________________________________________

##### Summary

```{r}
## Smoothness Metric
SMs_kern.08 <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', kern08.km5.sm$mean_discordant, kern08.km10.sm$mean_discordant, kern08.km15.sm$mean_discordant, kern08.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.08) <- c('Clustering Method', 'Kernel, 0.08')

SMs_kern.08_df <- as.data.frame(SMs_kern.08)

SMs_kern.08_df
```


__________________________________________________________________
__________________________________________________________________


### Mouse Brain Results Summary

#### Smoothness Metric

```{r}
SMs_list <- list(SMs_nonspac_df, SMs_uni_df, SMs_sub_df, SMs_kern.02_df, SMs_kern.05_df, SMs_kern.08_df)
SM_mousebrain <- Reduce(function(x, y) merge(x, y, ), SMs_list)

cols <- c(2:7)
SM_mousebrain[ , cols] <- apply(SM_mousebrain[ , cols,drop=F], 2,           
                    function(x) as.numeric(as.character(x)))

is.num <- sapply(SM_mousebrain, is.numeric)
SM_mousebrain[is.num] <- lapply(SM_mousebrain[is.num], round, 4)

SM_mousebrain
```


## Compostional Analysis

#### Uniform

*10 Nonspatial clusters on 10 Spatial Clusters*
```{r}
length(km.clus10.uni)
length(km.clus10.nonspac)

# check cluster frequencies
table(km.clus10.uni)
table(km.clus10.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus10.uni))
kmeans_labels <- sort(unique(km.clus10.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus10.uni)
kmeans_clus <- as.factor(km.clus10.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}

rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_x_continuous(breaks=c(1:10)) +
  theme_bw()
```


```{r}
xyplot_uni_km10 + labs(title="Spatial - uniform")
```

```{r}
xyplot_nonspac_km10 + labs(title="Non-spatial")
```


#### Kernel, 0.02

*10 Nonspatial clusters on 10 Spatial Clusters*
```{r}
length(km.clus10.kern02)
length(km.clus10.nonspac_sub)

# check cluster frequencies
table(km.clus10.kern02)
table(km.clus10.nonspac_sub)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus10.kern02))
kmeans_labels <- sort(unique(km.clus10.nonspac_sub))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus10.kern02)
kmeans_clus <- as.factor(km.clus10.nonspac_sub)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}

rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_x_continuous(breaks=c(1:10)) +
  theme_bw()
```


```{r}
xyplot_kern02_km10 + labs(title="Spatial - kernel (0.02)")  + guides(color = guide_legend(override.aes = list(size = 2, alpha=0.5)))
xyplot_nonspac.sub_km10 + labs(title="Non-spatial") + guides(color = guide_legend(override.aes = list(size = 2, alpha=0.5)))
```

________________________________________________________________________


#### Kernel, 0.05

*10 Nonspatial clusters on 10 Spatial Clusters*
```{r}
length(km.clus10.kern05)
length(km.clus10.nonspac_sub)

# check cluster frequencies
table(km.clus10.kern05)
table(km.clus10.nonspac_sub)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus10.kern05))
kmeans_labels <- sort(unique(km.clus10.nonspac_sub))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus10.kern05)
kmeans_clus <- as.factor(km.clus10.nonspac_sub)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}

rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_x_continuous(breaks=c(1:10)) +
  theme_bw()
```


```{r}
xyplot_kern05_km10 + labs(title="Spatial - kernel (0.05)") + guides(color = guide_legend(override.aes = list(size = 2, alpha=0.5)))
xyplot_nonspac.sub_km10 + labs(title="Non-spatial") + guides(color = guide_legend(override.aes = list(size = 2, alpha=0.5)))
```


_____________________________________________________________


#### Kernel, 0.08

*10 Nonspatial clusters on 10 Spatial Clusters*
```{r}
length(km.clus10.kern08)
length(km.clus10.nonspac_sub)

# check cluster frequencies
table(km.clus10.kern08)
table(km.clus10.nonspac_sub)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus10.kern08))
kmeans_labels <- sort(unique(km.clus10.nonspac_sub))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus10.kern05)
kmeans_clus <- as.factor(km.clus10.nonspac_sub)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}

rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_x_continuous(breaks=c(1:10)) +
  theme_bw()
```


```{r}
xyplot_kern08_km10 + labs(title="Spatial - kernel (0.08)") + guides(color = guide_legend(override.aes = list(size = 2, alpha=0.5)))
xyplot_nonspac.sub_km10 + labs(title="Non-spatial") + guides(color = guide_legend(override.aes = list(size = 2, alpha=0.5)))
```




