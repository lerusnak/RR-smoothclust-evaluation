---
title: "10x Genomics Xenium Mouse Brain"
author: "Lauren Rusnak"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Prep

```{r include=F}
library(MoleculeExperiment)
library(SpatialExperiment)
library(STexampleData)
library(scran)
library(ggplot2)
library(ggspavis)
library(scater)
library(smoothclust)
library(stats)
library(mclust)
library(randnet)
library(R.utils)
library(tibble)
library(dplyr)
```



## Import Data

```{r}
# Create molecule experiment object
setwd("C:/Users/lerus/OneDrive/Documents/BU-AB/ResearchRotation")
baseDir <- getwd()
dataDir <- file.path(baseDir,"10xXeniumData")

me <- readXenium(dataDir, keepCols = "essential") # takes about 3 minutes
me
```

```{r}
# transform into spatial experiment object
spe1 <- countMolecules(me)
spe1
```
- takes ~10-15 minuts


## Non-spatially aware workflow


### Normalization

```{r}
spe <- logNormCounts(spe1) 
spe
```

### Dimensionality Reduction
```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```


### Non-spatial Clustering


#### K means

##### 5 Clusters

```{r}

set.seed(123)

km.5 <- kmeans(pcs, centers = 5)

table(km.5$cluster)

# kmeans cluster assignments
km.clus5 <- km.5$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size=0.1) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


###### Smoothness Metric

```{r}
nonspac.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
nonspac.km5.sm$mean_discordant
```


##### 10 Clusters

```{r}

set.seed(123)

km.10 <- kmeans(pcs, centers = 10)

table(km.10$cluster)

# kmeans cluster assignments
km.clus10 <- km.10$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size = 0.1) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


###### Smoothness Metric

```{r}
nonspac.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
nonspac.km10.sm$mean_discordant
```



##### 15 Clusters

```{r}

set.seed(123)

km.15 <- kmeans(pcs, centers = 15)

table(km.15$cluster)

# kmeans cluster assignments
km.clus15 <- km.15$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size = 0.1) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


###### Smoothness Metric

```{r}
nonspac.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
nonspac.km15.sm$mean_discordant
```



##### 20 Clusters

```{r}

set.seed(123)

km.20 <- kmeans(pcs, centers = 20)

table(km.20$cluster)

# kmeans cluster assignments
km.clus20 <- km.20$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size = 0.1) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


###### Smoothness Metric

```{r}
nonspac.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
nonspac.km20.sm$mean_discordant
```


##### Summary

```{r}
## Smoothness Metric
SMs_nonspac <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', nonspac.km5.sm$mean_discordant, nonspac.km10.sm$mean_discordant, nonspac.km15.sm$mean_discordant, nonspac.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_nonspac) <- c('Clustering Method', 'Non-Spatial')

SMs_nonspac_df <- as.data.frame(SMs_nonspac)

SMs_nonspac_df
```

___________________________________________________________________
___________________________________________________________________



### **Run smoothclust with different parameters**

#### Method: Uniform

```{r}
# library(smoothclust)
spe <- smoothclust(spe1, method = "uniform")
assayNames(spe)
```
  -> takes about 35 minutes
  
  

##### Normalization

```{r}
spe <- logNormCounts(spe) 
spe
```



##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```

```{r}
# UMAP
set.seed(123)

spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "UMAP"))

colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

```



##### K-means clustering 

###### Deciding Number of clusters


```{r}
n_clusters <- 15

# Initialize total within sum of squares error: wss
wss <- numeric(n_clusters)

set.seed(123)

# Look over 1 to n possible clusters
for (i in 1:n_clusters) {
  # Fit the model: km.out
  km.out <- kmeans(pcs, centers = i, nstart = 20)
  # Save the within cluster sum of squares
  wss[i] <- km.out$tot.withinss
}
```


```{r}
# Produce a scree plot
wss_df <- tibble(clusters = 1:n_clusters, wss = wss)
 
scree_plot <- ggplot(wss_df, aes(x = clusters, y = wss, group = 1)) +
    geom_point(size = 4)+
    geom_line() +
    xlab('Number of clusters') +
    scale_x_continuous(breaks = c(2,4,6,8,10,12,14,16))
scree_plot
```

*Does not really help very much*


###### 5 Clusters

```{r}

set.seed(123)

km.5 <- kmeans(pcs, centers = 5)

table(km.5$cluster)

# kmeans cluster assignments
km.clus5 <- km.5$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, type = "PCA", 
           annotate = "label", palette = "libd_layer_colors",
           size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, type = "UMAP", 
           annotate = "label", palette = "libd_layer_colors",
           size = 0.5)
```


*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size=0.1) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
uni.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
uni.km5.sm$mean_discordant
```


________________________________________________________________________


###### 10 Clusters

```{r}

set.seed(123)

km.10 <- kmeans(pcs, centers = 10)

table(km.10$cluster)

# kmeans cluster assignments
km.clus10 <- km.10$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10)
```

####### **Visualization**

```{r}
colors <- c("red4", "orangered", "orange", "gold", "seagreen", "turquoise", "dodgerblue", "mediumblue", "lightslateblue", "magenta3", "deeppink")
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, type = "PCA", 
           annotate = "label", palette = colors,
           size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, type = "UMAP", 
           annotate = "label", palette = colors,
           size = 0.5)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, 0.2) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
uni.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
uni.km10.sm$mean_discordant
```


_____________________________________________________________________


###### 15 Clusters

```{r}

set.seed(123)

km.15 <- kmeans(pcs, centers = 15)

table(km.15$cluster)

# kmeans cluster assignments
km.clus15 <- km.15$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15)
```

####### **Visualization**

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.2, size=0.1) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```



####### Smoothness Metric

```{r}
uni.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
uni.km15.sm$mean_discordant
```


________________________________________________________________________


###### 20 Clusters

```{r}

set.seed(123)

km.20 <- kmeans(pcs, centers = 20)

table(km.10$cluster)

# kmeans cluster assignments
km.clus20 <- km.20$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20)
```


####### **Visualization**

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, 0.2) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
uni.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
uni.km20.sm$mean_discordant
```


_______________________________________________________________

##### Summary

```{r}
## Smoothness Metric
SMs_uni <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', uni.km5.sm$mean_discordant, uni.km10.sm$mean_discordant, uni.km15.sm$mean_discordant, uni.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_uni) <- c('Clustering Method', 'Uniform')

SMs_uni_df <- as.data.frame(SMs_uni)

SMs_uni_df
```





__________________________________________________________________
__________________________________________________________________



### Sub sample

```{r}
idx <- 1:ncol(spe1)
set.seed(123)
idx_keep <- sample(idx, ncol(spe1)/10)
spe_sub <- spe1[, idx_keep]
dim(spe_sub)
```

#### Non-spatially aware workflow

##### Normalization

```{r}
spe <- logNormCounts(spe_sub) 
spe
```


##### Dimensionality Reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```


##### Clustering on subsample 

##### Graph-based

```{r}
set.seed(123)
k <- 30
g <- buildSNNGraph(spe, k = k, use.dimred="PCA")
g_walk <- igraph::cluster_walktrap(g)
clus <- g_walk$membership
table(clus)
```

*X-Y  Spatial Plot*
```{r}
colLabels(spe) <- factor(clus)
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```

####### Smoothness Metric

```{r}
sub.graph.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
sub.graph.sm$mean_discordant
```


##### k-means

###### 5 Clusters

```{r}

set.seed(123)

km.5 <- kmeans(pcs, centers = 5)

table(km.5$cluster)

# kmeans cluster assignments
km.clus5 <- km.5$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
sub.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
sub.km5.sm$mean_discordant
```


__________________________________________________


###### 10 Clusters

```{r}

set.seed(123)

km.10 <- kmeans(pcs, centers = 10)

table(km.10$cluster)

# kmeans cluster assignments
km.clus10 <- km.10$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
sub.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
sub.km10.sm$mean_discordant
```

_____________________________________________________________


###### 15 Clusters

```{r}

set.seed(123)

km.15 <- kmeans(pcs, centers = 15)

table(km.15$cluster)

# kmeans cluster assignments
km.clus15 <- km.15$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
sub.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
sub.km15.sm$mean_discordant
```


__________________________________________________________


###### 20 Clusters

```{r}

set.seed(123)

km.20 <- kmeans(pcs, centers = 20)

table(km.20$cluster)

# kmeans cluster assignments
km.clus20 <- km.20$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```



####### Smoothness Metric

```{r}
sub.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
sub.km20.sm$mean_discordant
```

_______________________________________________________________


##### Summary

```{r}
## Smoothness Metric
SMs_sub <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', sub.km5.sm$mean_discordant, sub.km10.sm$mean_discordant, sub.km15.sm$mean_discordant, sub.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_sub) <- c('Clustering Method', 'Subsample Non-Spatial')

SMs_sub_df <- as.data.frame(SMs_sub)

SMs_sub_df
```





_______________________________________________________________________
_______________________________________________________________________



#### Method: Kernel, bandwidth = 0.02

```{r}
# library(smoothclust)
spe <- smoothclust(spe_sub, method = "kernel", bandwidth = 0.02)
assayNames(spe)
```

  

##### Normalization

```{r}
spe <- logNormCounts(spe) 
spe
```




##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```

```{r}
# UMAP
set.seed(123)

spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "UMAP"))

colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

```



##### K-means clustering 


###### 5 Clusters

```{r}

set.seed(123)

km.5 <- kmeans(pcs, centers = 5)

table(km.5$cluster)

# kmeans cluster assignments
km.clus5 <- km.5$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, type = "PCA", 
           annotate = "label", palette = "libd_layer_colors",
           size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, type = "UMAP", 
           annotate = "label", palette = "libd_layer_colors",
           size = 0.5)
```


*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.8) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
kern02.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern02.km5.sm$mean_discordant
```


__________________________________________________________________


###### 10 Clusters

```{r}

set.seed(123)

km.10 <- kmeans(pcs, centers = 10)

table(km.10$cluster)

# kmeans cluster assignments
km.clus10 <- km.10$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10)
```

####### **Visualization**

```{r}
colors <- c("red4", "orangered", "orange", "gold", "seagreen", "turquoise", "dodgerblue", "mediumblue", "lightslateblue", "magenta3", "deeppink")
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, type = "PCA", 
           annotate = "label", palette = colors,
           size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, type = "UMAP", 
           annotate = "label", palette = colors,
           size = 0.5)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.8) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
kern02.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern02.km10.sm$mean_discordant
```


_____________________________________________________________


###### 15 Clusters

```{r}

set.seed(123)

km.15 <- kmeans(pcs, centers = 15)

table(km.15$cluster)

# kmeans cluster assignments
km.clus15 <- km.15$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
kern02.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern02.km15.sm$mean_discordant
```


__________________________________________________________


###### 20 Clusters

```{r}

set.seed(123)

km.20 <- kmeans(pcs, centers = 20)

table(km.20$cluster)

# kmeans cluster assignments
km.clus20 <- km.20$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```



####### Smoothness Metric

```{r}
kern02.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern02.km20.sm$mean_discordant
```


_______________________________________________________________

##### Summary

```{r}
## Smoothness Metric
SMs_kern.02 <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', kern02.km5.sm$mean_discordant, kern02.km10.sm$mean_discordant, kern02.km15.sm$mean_discordant, kern02.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.02) <- c('Clustering Method', 'Kernel, 0.02')

SMs_kern.02_df <- as.data.frame(SMs_kern.02)

SMs_kern.02_df
```




__________________________________________________________________
__________________________________________________________________





#### Method: Kernel, bandwidth = 0.05

```{r}
# library(smoothclust)
spe <- smoothclust(spe_sub, method = "kernel", bandwidth = 0.05)
assayNames(spe)
```

  

##### Normalization

```{r}
spe <- logNormCounts(spe) 
spe
```



##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```

```{r}
# UMAP
set.seed(123)

spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "UMAP"))

colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

```



##### K-means clustering 

###### 5 Clusters

```{r}

set.seed(123)

km.5 <- kmeans(pcs, centers = 5)

table(km.5$cluster)

# kmeans cluster assignments
km.clus5 <- km.5$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, type = "PCA", 
           annotate = "label", palette = "libd_layer_colors",
           size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, type = "UMAP", 
           annotate = "label", palette = "libd_layer_colors",
           size = 0.5)
```


*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.8) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```



####### Smoothness Metric

```{r}
kern05.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern05.km5.sm$mean_discordant
```


________________________________________________________________



###### 10 Clusters

```{r}

set.seed(123)

km.10 <- kmeans(pcs, centers = 10)

table(km.10$cluster)

# kmeans cluster assignments
km.clus10 <- km.10$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10)
```

####### **Visualization**

```{r}
colors <- c("red4", "orangered", "orange", "gold", "seagreen", "turquoise", "dodgerblue", "mediumblue", "lightslateblue", "magenta3", "deeppink")
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, type = "PCA", 
           annotate = "label", palette = colors,
           size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, type = "UMAP", 
           annotate = "label", palette = colors,
           size = 0.5)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.8) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```



####### Smoothness Metric

```{r}
kern05.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern05.km10.sm$mean_discordant
```


_____________________________________________________________


###### 15 Clusters

```{r}

set.seed(123)

km.15 <- kmeans(pcs, centers = 15)

table(km.15$cluster)

# kmeans cluster assignments
km.clus15 <- km.15$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
kern05.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern05.km15.sm$mean_discordant
```


__________________________________________________________


###### 20 Clusters

```{r}

set.seed(123)

km.20 <- kmeans(pcs, centers = 20)

table(km.20$cluster)

# kmeans cluster assignments
km.clus20 <- km.20$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```



####### Smoothness Metric

```{r}
kern05.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern05.km20.sm$mean_discordant
```


_______________________________________________________________

##### Summary

```{r}
## Smoothness Metric
SMs_kern.05 <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', kern05.km5.sm$mean_discordant, kern05.km10.sm$mean_discordant, kern05.km15.sm$mean_discordant, kern05.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.05) <- c('Clustering Method', 'Kernel, 0.05')

SMs_kern.05_df <- as.data.frame(SMs_kern.05)

SMs_kern.05_df
```




__________________________________________________________________
__________________________________________________________________



#### Method: Kernel, bandwidth = 0.08

```{r}
# library(smoothclust)
spe <- smoothclust(spe_sub, method = "kernel", bandwidth = 0.08)
assayNames(spe)
```


  
##### Normalization

```{r}
spe <- logNormCounts(spe) 
spe
```



##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```

```{r}
# UMAP
set.seed(123)

spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "UMAP"))

colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

```



##### K-means clustering 

###### 5 Clusters

```{r}

set.seed(123)

km.5 <- kmeans(pcs, centers = 5)

table(km.5$cluster)

# kmeans cluster assignments
km.clus5 <- km.5$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus5)
```

####### **Visualization**

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, type = "PCA", 
           annotate = "label", palette = "libd_layer_colors",
           size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, type = "UMAP", 
           annotate = "label", palette = "libd_layer_colors",
           size = 0.5)
```


*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.8) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
kern08.km5.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern08.km5.sm$mean_discordant
```


________________________________________________________________________


###### 10 Clusters

```{r}

set.seed(123)

km.10 <- kmeans(pcs, centers = 10)

table(km.10$cluster)

# kmeans cluster assignments
km.clus10 <- km.10$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10)
```

####### **Visualization**

```{r}
colors <- c("red4", "orangered", "orange", "gold", "seagreen", "turquoise", "dodgerblue", "mediumblue", "lightslateblue", "magenta3", "deeppink")
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, type = "PCA", 
           annotate = "label", palette = colors,
           size = 0.5)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, type = "UMAP", 
           annotate = "label", palette = colors,
           size = 0.5)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size = 0.8) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```




####### Smoothness Metric

```{r}
kern08.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern08.km10.sm$mean_discordant
```


_____________________________________________________________


###### 15 Clusters

```{r}

set.seed(123)

km.15 <- kmeans(pcs, centers = 15)

table(km.15$cluster)

# kmeans cluster assignments
km.clus15 <- km.15$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus15)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```


####### Smoothness Metric

```{r}
kern08.km15.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern08.km15.sm$mean_discordant
```


__________________________________________________________


###### 20 Clusters

```{r}

set.seed(123)

km.20 <- kmeans(pcs, centers = 20)

table(km.20$cluster)

# kmeans cluster assignments
km.clus20 <- km.20$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus20)
```

*X-Y  Spatial Plot*
```{r}
coldat_df <- as.data.frame(colData(spe))

coldat_df <- coldat_df %>%
  mutate(y_reverse = -1*y_location)

ggplot(coldat_df, aes(x = x_location, y = y_reverse, color = label)) +
  geom_point(alpha = 0.3, size=0.7) +
  theme_bw() +
  theme(axis.text = element_blank(), axis.title = element_blank())
```



####### Smoothness Metric

```{r}
kern08.km20.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=10)
```

```{r}
kern08.km20.sm$mean_discordant
```

_______________________________________________________________

##### Summary

```{r}
## Smoothness Metric
SMs_kern.08 <- matrix(c('kmeans (5 clusters)','kmeans (10 clusters)','kmeans (15 clusters)','kmeans (20 clusters)', kern08.km5.sm$mean_discordant, kern08.km10.sm$mean_discordant, kern08.km15.sm$mean_discordant, kern08.km20.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.08) <- c('Clustering Method', 'Kernel, 0.08')

SMs_kern.08_df <- as.data.frame(SMs_kern.08)

SMs_kern.08_df
```


__________________________________________________________________
__________________________________________________________________


### Mouse Brain Results Summary

#### Smoothness Metric

```{r}
SMs_list <- list(SMs_nonspac_df, SMs_uni_df, SMs_sub_df, SMs_kern.02_df, SMs_kern.05_df, SMs_kern.08_df)
SM_DLPFC <- Reduce(function(x, y) merge(x, y, ), SMs_list)

cols <- c(2:6)
SM_DLPFC[ , cols] <- apply(SM_DLPFC[ , cols,drop=F], 2,           
                    function(x) as.numeric(as.character(x)))

is.num <- sapply(SM_DLPFC, is.numeric)
SM_DLPFC[is.num] <- lapply(SM_DLPFC[is.num], round, 4)

SM_DLPFC
```


*TO DO*

  + run everything
  + create summary table with all smoothing metrics
  + smoothing metrics for DLPFC
  + Entire workflow for Breast Cancer





