---
title: "smoothclust on 10x Genomics Visium Human DLPFC"
author: "Lauren Rusnak and Dr. Lukas Weber"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Prep

Packages:
```{r}
library(SpatialExperiment)
library(STexampleData)
library(scran)
library(ggspavis)
library(scater)
library(smoothclust)
library(stats)
library(mclust)
library(randnet)
```


Color pallete:
```{r}
colors <- c("red4", "orangered", "orange", "gold", "seagreen", "turquoise", "dodgerblue", "mediumblue", "lightslateblue", "magenta3", "deeppink")
```



### Load human DLPFC Data

*Download data object*
```{r}
spe1 <- Visium_humanDLPFC() 
spe1 <- spe1[, colData(spe1)$in_tissue == 1]
```

### Non-spatially aware clustering workflow 


##### Normalization

```{r}
spe <- logNormCounts(spe1) 
```


##### Feature Selection

```{r}
is_mito <- grepl("(^MT-)|(^mt-)", rowData(spe)$gene_name)
spe <- spe[!is_mito, ]

spe_full <- spe

# library(scran)

dec <- modelGeneVar(spe) 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```


##### Dimensionality Reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, ncomponents = 50, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```

##### K means

###### 7 Clusters

```{r}

set.seed(123)

km.7.nonspac <- kmeans(pcs, centers = 7)

table(km.7.nonspac$cluster)

# kmeans cluster assignments
km.clus7.nonspac <- km.7.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus7.nonspac)
```

*X-Y  Spatial Plot*
```{r}
xyplot_nonspac_km7 <- plotSpots(spe, annotate = "label", 
          pal = "libd_layer_colors",
          point_size = 0.7)
```

###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_nonspac_km.clus7 <- adjustedRandIndex(colData(spe)$ground_truth,km.clus7.nonspac)
ARI_nonspac_km.clus7
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_nonspac_km.clus7 <- NMI(colData(spe)$ground_truth, km.clus7.nonspac)
NMI_nonspac_km.clus7
```


###### Smoothness Metric

```{r}
nonspac.km7.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

nonspac.km7.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- nonspac.km7.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```



###### 8 Clusters

```{r}

set.seed(123)

km.8.nonspac <- kmeans(pcs, centers = 8)

table(km.8.nonspac$cluster)

# kmeans cluster assignments
km.clus8.nonspac <- km.8.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.nonspac)
```

*X-Y  Spatial Plot*
```{r}
xyplot_nonspac_km8 <- plotSpots(spe, annotate = "label", 
          pal = "libd_layer_colors",
          point_size = 0.7)
```

###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_nonspac_km.clus8 <- adjustedRandIndex(colData(spe)$ground_truth,km.clus8.nonspac)
ARI_nonspac_km.clus8
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_nonspac_km.clus8 <- NMI(colData(spe)$ground_truth, km.clus8.nonspac)
NMI_nonspac_km.clus8
```

###### Smoothness Metric

```{r}
nonspac.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

nonspac.km8.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- nonspac.km8.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```



###### 10 Clusters

```{r}

set.seed(123)

km.10.nonspac <- kmeans(pcs, centers = 10)

table(km.10.nonspac$cluster)

# kmeans cluster assignments
km.clus10.nonspac <- km.10.nonspac$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.nonspac)
```

*X-Y  Spatial Plot*
```{r}
xyplot_nonspac_km10 <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)
xyplot_nonspac_km10
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_nonspac_km.clus10 <- adjustedRandIndex(colData(spe)$ground_truth,km.clus10.nonspac)
ARI_nonspac_km.clus10
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_nonspac_km.clus10 <- NMI(colData(spe)$ground_truth, km.clus10.nonspac)
NMI_nonspac_km.clus10
```


###### Smoothness Metric

```{r}
nonspac.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

nonspac.km10.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- nonspac.km10.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```



##### Graph-based clustering

```{r}
# graph-based clustering
set.seed(123)
k <- 45
g <- buildSNNGraph(spe, k = k,  use.dimred = "PCA")
g_walk <- igraph::cluster_walktrap(g)
g_clus.nonspac <- g_walk$membership
table(g_clus.nonspac)

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(g_clus.nonspac)
```

*X-Y  Spatial Plot*
```{r}
xyplot_nonspac_graph <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_nonspac_graph <- adjustedRandIndex(colData(spe)$ground_truth,g_clus.nonspac)
ARI_nonspac_graph
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_nonspac_graph <- NMI(colData(spe)$ground_truth, g_clus.nonspac)
NMI_nonspac_graph
```

###### Smoothness Metric

```{r}
nonspac.graph.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

nonspac.graph.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- nonspac.graph.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```


##### SUMMARY

```{r}
## ARI
ARIs_nonspac <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', ARI_nonspac_km.clus7, ARI_nonspac_km.clus8, ARI_nonspac_km.clus10, ARI_nonspac_graph), ncol=2, byrow=F)

colnames(ARIs_nonspac) <- c('Clustering Method', 'Non-spatial')

ARIs_nonspac_df <- as.data.frame(ARIs_nonspac)

ARIs_nonspac_df
```

```{r}
## NMI
NMIs_nonspac <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', NMI_nonspac_km.clus7, NMI_nonspac_km.clus8, NMI_nonspac_km.clus10, NMI_nonspac_graph), ncol=2, byrow=F)

colnames(NMIs_nonspac) <- c('Clustering Method', 'Non-spatial')

NMIs_nonspac_df <- as.data.frame(NMIs_nonspac)

NMIs_nonspac_df
```


```{r}
## SM
SMs_nonspac <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', nonspac.km7.sm$mean_discordant, nonspac.km8.sm$mean_discordant, nonspac.km10.sm$mean_discordant, nonspac.graph.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_nonspac) <- c('Clustering Method', 'Non-spatial')

SMs_nonspac_df <- as.data.frame(SMs_nonspac)

SMs_nonspac_df
```



_________________________________________________________________________


### Spatially aware clustering workflow 

#### Method: Uniform

```{r, include = FALSE}
# library(smoothclust)
spe <- smoothclust(spe1, method = "uniform")

assayNames(spe)
```


##### Normalization

```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
assayNames(spe)
```


##### Feature Selection

```{r}
is_mito <- grepl("(^MT-)|(^mt-)", rowData(spe)$gene_name)
spe <- spe[!is_mito, ]

spe_full <- spe

# library(scran)

dec <- modelGeneVar(spe) 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```


##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs, exprs_values = "logcounts")

# UMAP on top 50 PCs -> for visualization
set.seed(123)
spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))
dim(reducedDim(spe, "UMAP"))

# update column names
colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

# Vector of principal commponents for clustering 
pcs <- reducedDim(spe, "PCA")
```


##### K-means clustering with 7 centers
```{r}
## 7 centers (one fore each true layer + 1 for white matter)

set.seed(123)

km.7.uni <- kmeans(pcs, centers = 7)

table(km.7.uni$cluster)

# kmeans cluster assignments
km.clus7.uni <- km.7.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus7.uni)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_uni_km7 <- plotSpots(spe, annotate = "label", 
          pal = "Okabe-Ito",
          point_size = 0.7)

# plot ground truth labels in spatial coordinates
xyplot_groundtruth <- plotSpots(spe, annotate = "ground_truth", 
          pal = "Okabe-Ito",
          point_size = 0.7) 

gridExtra::grid.arrange(xyplot_uni_km7, xyplot_groundtruth, ncol=2)

```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_uni_km.clus7 <- adjustedRandIndex(colData(spe)$ground_truth,km.clus7.uni)
ARI_uni_km.clus7
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_uni_km.clus7 <- NMI(colData(spe)$ground_truth, km.clus7.uni)
NMI_uni_km.clus7
```

###### Smoothness Metric

```{r}
uni.km7.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

uni.km7.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- uni.km7.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```




##### K-means clustering with 8 centers
```{r}
## 8 centers (one fore each true layer + 2 for white matter)

set.seed(123)

km.8.uni <- kmeans(pcs, centers = 8)

table(km.8.uni$cluster)

# kmeans cluster assignments
km.clus8.uni <- km.8.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.uni)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_uni_km8 <- plotSpots(spe, annotate = "label", 
          pal = "Okabe-Ito",
          point_size = 0.8)

gridExtra::grid.arrange(xyplot_uni_km8, xyplot_groundtruth, ncol=2)
```

*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_uni_km.clus8 <- adjustedRandIndex(colData(spe)$ground_truth, km.clus8.uni)
ARI_uni_km.clus8
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_uni_km.clus8 <- NMI(colData(spe)$ground_truth, km.clus8.uni)
NMI_uni_km.clus8
```

###### **Smoothness Metric**

```{r}
uni.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

uni.km8.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- uni.km8.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```



##### K-means clustering with 10 centers
```{r}
## 10 centers

set.seed(123)

km.10.uni <- kmeans(pcs, centers = 10)

table(km.10.uni$cluster)

# kmeans cluster assignments
km.clus10.uni <- km.10.uni$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.uni)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_uni_km10 <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)

gridExtra::grid.arrange(xyplot_uni_km10, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = colors,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = colors,
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_uni_km.clus10 <- adjustedRandIndex(colData(spe)$ground_truth, km.clus10.uni)
ARI_uni_km.clus10
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_uni_km.clus10 <- NMI(colData(spe)$ground_truth, km.clus10.uni)
NMI_uni_km.clus10 
```


###### **Smoothness Metric**

```{r}
uni.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

uni.km10.sm$mean_discordant
```


*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- uni.km10.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```


##### Graph-based clustering
```{r}
# graph-based clustering
set.seed(123)
k <- 50
g <- buildSNNGraph(spe, k = k,  use.dimred = "PCA")
g_walk <- igraph::cluster_walktrap(g)
g_clus.uni <- g_walk$membership
table(g_clus.uni)

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(g_clus.uni)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_uni_graph <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_uni_graph, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = colors,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = colors,
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_uni_graph <- adjustedRandIndex(colData(spe)$ground_truth, g_clus.uni)
ARI_uni_graph
```


###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_uni_graph <- NMI(colData(spe)$ground_truth, g_clus.uni)
NMI_uni_graph
```


###### **Smoothness Metric**

```{r}
uni.graph.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

uni.graph.sm$mean_discordant
```


*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- uni.graph.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```



##### SUMMARY

```{r}
## Visualizations
gridExtra::grid.arrange( 
  xyplot_uni_km7,
  xyplot_uni_km8,
  xyplot_uni_km10,
  xyplot_uni_graph,
  ncol=2)
 xyplot_groundtruth
```

```{r}
## ARI
ARIs_uni <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', ARI_uni_km.clus7, ARI_uni_km.clus8, ARI_uni_km.clus10, ARI_uni_graph), ncol=2, byrow=F)

colnames(ARIs_uni) <- c('Clustering Method', 'Uniform')

ARIs_uni_df <- as.data.frame(ARIs_uni)

ARIs_uni_df
```

```{r}
## NMI
NMIs_uni <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', NMI_uni_km.clus7, NMI_uni_km.clus8, NMI_uni_km.clus10, NMI_uni_graph), ncol=2, byrow=F)

colnames(NMIs_uni) <- c('Clustering Method', 'Uniform')

NMIs_uni_df <- as.data.frame(NMIs_uni)

NMIs_uni_df
```


```{r}
## SM
SMs_uni <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', uni.km7.sm$mean_discordant, uni.km8.sm$mean_discordant, uni.km10.sm$mean_discordant, uni.graph.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_uni) <- c('Clustering Method', 'Uniform')

SMs_uni_df <- as.data.frame(SMs_uni)

SMs_uni_df
```


_________________________________________________________________________
_________________________________________________________________________


#### Method: Kernel, bandwidth = 0.02

```{r, include=FALSE}
# library(smoothclust)

# run smoothclust
spe <- smoothclust(spe1, method = "kernel", bandwidth = 0.02)
assayNames(spe)
```


##### Normalization

```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
assayNames(spe)
```


##### Feature Selection

```{r}
is_mito <- grepl("(^MT-)|(^mt-)", rowData(spe)$gene_name)
spe <- spe[!is_mito, ]

spe_full <- spe

# library(scran)

dec <- modelGeneVar(spe) 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```



##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs, exprs_values = "logcounts")

# UMAP on top 50 PCs -> for visualization
set.seed(123)
spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))
dim(reducedDim(spe, "UMAP"))

# update column names
colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

# Principal components for k-means clustering
pcs <- reducedDim(spe, "PCA")
```



##### K-means clustering with 7 centers
```{r}
## 7 centers (one fore each true layer + 1 for white matter)

set.seed(123)

km.7.kern02 <- kmeans(pcs, centers = 7)

table(km.7.kern02$cluster)

# kmeans cluster assignments
km.clus7.kern02 <- km.7.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus7.kern02)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.02_km7 <- plotSpots(spe, annotate = "label", 
          pal = "Okabe-Ito",
          point_size = 0.7)

gridExtra::grid.arrange(xyplot_kern.02_km7, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.02_km.clus7 <- adjustedRandIndex(colData(spe)$ground_truth,km.clus7.kern02)
ARI_kern.02_km.clus7
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.02_km.clus7 <- NMI(colData(spe)$ground_truth,km.clus7.kern02)
NMI_kern.02_km.clus7
```


###### **Smoothness Metric**

```{r}
kern.02.km7.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.02.km7.sm$mean_discordant
```


*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- kern.02.km7.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```




##### K-means clustering with 8 centers
```{r}
## 8 centers (one fore each true layer + 2 for white matter)

set.seed(123)

km.8.kern02 <- kmeans(pcs, centers = 8)

table(km.8.kern02$cluster)

# kmeans cluster assignments
km.clus8.kern02 <- km.8.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.kern02)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.02_km8 <- plotSpots(spe, annotate = "label", 
          pal = "Okabe-Ito",
          point_size = 0.7)

gridExtra::grid.arrange(xyplot_kern.02_km8, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.02_km.clus8 <- adjustedRandIndex(colData(spe)$ground_truth, km.clus8.kern02)
ARI_kern.02_km.clus8
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.02_km.clus8 <- NMI(colData(spe)$ground_truth, km.clus8.kern02)
NMI_kern.02_km.clus8
```

###### **Smoothness Metric**

```{r}
kern.02.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.02.km8.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- kern.02.km8.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```



##### K-means clustering with 10 centers
```{r}
## 10 centers

set.seed(123)

km.10.kern02 <- kmeans(pcs, centers = 10)

table(km.10.kern02$cluster)

# kmeans cluster assignments
km.clus10.kern02 <- km.10.kern02$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.kern02)
```

###### **Visualizaton**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.02_km10 <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)

gridExtra::grid.arrange(xyplot_kern.02_km10, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = colors,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = colors,
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.02_km.clus10 <- adjustedRandIndex(colData(spe)$ground_truth, km.clus10.kern02)
ARI_kern.02_km.clus10
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.02_km.clus10 <- NMI(colData(spe)$ground_truth, km.clus10.kern02)
NMI_kern.02_km.clus10
```

###### **Smoothness Metric**

```{r}
kern.02.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.02.km10.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- kern.02.km10.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```



##### Graph-based clustering
```{r}
# graph-based clustering
set.seed(123)
k <- 48
g <- buildSNNGraph(spe, k = k,  use.dimred = "PCA")
g_walk <- igraph::cluster_walktrap(g)
g_clus.kern02 <- g_walk$membership
table(g_clus.kern02)

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(g_clus.kern02)
```

###### **Visualizaton**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.02_graph <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)

gridExtra::grid.arrange(xyplot_kern.02_graph , xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = colors,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = colors,
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.02_graph <- adjustedRandIndex(colData(spe)$ground_truth, g_clus.kern02)
ARI_kern.02_graph
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.02_graph <- NMI(colData(spe)$ground_truth, g_clus.kern02)
NMI_kern.02_graph
```

###### **Smoothness Metric**

```{r}
kern.02.graph.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.02.graph.sm$mean_discordant
```

*X-Y  Spatial Plot - SM*
```{r}
colData(spe)$SM <- kern.02.graph.sm$n_discordant
plotSpots(spe, annotate = "SM", 
          pal = c("gray", "red"),
          point_size = 1)
```


##### SUMMARY

```{r}
## Visualizations
gridExtra::grid.arrange( 
  xyplot_kern.02_km7,
  xyplot_kern.02_km8,
  xyplot_kern.02_km10,
  xyplot_kern.02_graph,
  xyplot_groundtruth,
  ncol=2)
```

```{r}
## ARI
ARIs_kern.02 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', ARI_kern.02_km.clus7, ARI_kern.02_km.clus8, ARI_kern.02_km.clus10, ARI_kern.02_graph), ncol=2, byrow=F)

colnames(ARIs_kern.02) <- c('Clustering Method','Kernel, 0.02')

ARIs_kern.02_df <- as.data.frame(ARIs_kern.02)

ARIs_kern.02_df
```

```{r}
## NMI
NMIs_kern.02 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', NMI_kern.02_km.clus7, NMI_kern.02_km.clus8, NMI_kern.02_km.clus10, NMI_kern.02_graph), ncol=2, byrow=F)

colnames(NMIs_kern.02) <- c('Clustering Method','Kernel, 0.02')

NMIs_kern.02_df <- as.data.frame(NMIs_kern.02)

NMIs_kern.02_df
```



```{r}
## SM
SMs_kern.02 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', kern.02.km7.sm$mean_discordant, kern.02.km8.sm$mean_discordant, kern.02.km10.sm$mean_discordant, kern.02.graph.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.02) <- c('Clustering Method', 'Kernel, 0.02')

SMs_kern.02_df <- as.data.frame(SMs_kern.02)

SMs_kern.02_df
```


_______________________________________________________________________
_______________________________________________________________________


#### Method: kernel, bandwidth = 0.04


```{r, include=FALSE}
# library(smoothclust)

# run smoothclust
spe <- smoothclust(spe1, method = "kernel", bandwidth = 0.04)

# check
assayNames(spe)
```



##### Normalization

```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
assayNames(spe)
```


##### Feature Selection

```{r}
is_mito <- grepl("(^MT-)|(^mt-)", rowData(spe)$gene_name)
spe <- spe[!is_mito, ]

spe_full <- spe

# library(scran)

dec <- modelGeneVar(spe) 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```


##### Dimensionality reduction

```{r}
# compute PCA
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs, exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))

# UMAP on top 50 PCs -> for visualization
set.seed(123)
spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "UMAP"))

# update column names
colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

pcs <- reducedDim(spe, "PCA")
```



##### K-means clustering with 7 centers
```{r}
## 7 centers (one fore each true layer + 1 for white matter)

set.seed(123)

km.7.kern04 <- kmeans(pcs, centers = 7)

table(km.7.kern04$cluster)

# kmeans cluster assignments
km.clus7.kern04 <- km.7.kern04$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus7.kern04)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.04_km7 <- plotSpots(spe, annotate = "label", 
          pal = "Okabe-Ito",
          point_size = 0.7)

gridExtra::grid.arrange(xyplot_kern.04_km7, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.04_km.clus7 <- adjustedRandIndex(colData(spe)$ground_truth,km.clus7.kern04)
ARI_kern.04_km.clus7
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.04_km.clus7 <- NMI(colData(spe)$ground_truth,km.clus7.kern04)
NMI_kern.04_km.clus7
```

###### **Smoothness Metric**

```{r}
kern.04.km7.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.04.km7.sm$mean_discordant
```



##### K-means clustering with 8 centers
```{r}
## 8 centers (one fore each true layer + 2 for white matter)

set.seed(123)

km.8.kern04 <- kmeans(pcs, centers = 8)

table(km.8.kern04$cluster)

# kmeans cluster assignments
km.clus8.kern04 <- km.8.kern04$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.kern04)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.04_km8 <- plotSpots(spe, annotate = "label", 
          pal = "Okabe-Ito",
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.04_km8, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.04_km.clus8 <- adjustedRandIndex(colData(spe)$ground_truth, km.clus8.kern04)
ARI_kern.04_km.clus8
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.04_km.clus8 <- NMI(colData(spe)$ground_truth, km.clus8.kern04)
NMI_kern.04_km.clus8
```

###### **Smoothness Metric**

```{r}
kern.04.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.04.km8.sm$mean_discordant
```



##### K-means clustering with 10 centers
```{r}
## 10 centers

set.seed(123)

km.10.kern04 <- kmeans(pcs, centers = 10)

table(km.10.kern04$cluster)

# kmeans cluster assignments
km.clus10.kern04 <- km.10.kern04$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.kern04)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.04_km10 <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.04_km10, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = colors,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = colors,
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.04_km.clus10 <- adjustedRandIndex(colData(spe)$ground_truth, km.clus10.kern04)
ARI_kern.04_km.clus10
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.04_km.clus10 <- NMI(colData(spe)$ground_truth, km.clus10.kern04)
NMI_kern.04_km.clus10
```

###### **Smoothness Metric**

```{r}
kern.04.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.04.km10.sm$mean_discordant
```




##### Graph-based clustering
```{r}
# graph-based clustering
set.seed(123)
k <- 40
g <- buildSNNGraph(spe, k = k,  use.dimred = "PCA")
g_walk <- igraph::cluster_walktrap(g)
g_clus.kern04 <- g_walk$membership
table(g_clus.kern04)

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(g_clus.kern04)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.04_graph <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.04_graph, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = colors,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = colors,
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.04_graph <- adjustedRandIndex(colData(spe)$ground_truth, g_clus.kern04)
ARI_kern.04_graph
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.04_graph <- NMI(colData(spe)$ground_truth, g_clus.kern04)
NMI_kern.04_graph
```

###### **Smoothness Metric**

```{r}
kern.04.graph.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.04.graph.sm$mean_discordant
```



##### SUMMARY

```{r}
## Visualizations
gridExtra::grid.arrange( 
  xyplot_kern.04_km7,
  xyplot_kern.04_km8,
  xyplot_kern.04_km10,
  xyplot_kern.04_graph,
  xyplot_groundtruth,
  ncol=2)
```

```{r}
## ARI
ARIs_kern.04 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', ARI_kern.04_km.clus7, ARI_kern.04_km.clus8, ARI_kern.04_km.clus10, ARI_kern.04_graph), ncol=2, byrow=F)

colnames(ARIs_kern.04) <- c('Clustering Method','Kernel, 0.04')

ARIs_kern.04_df <- as.data.frame(ARIs_kern.04)

ARIs_kern.04_df
```


```{r}
## NMI
NMIs_kern.04 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', NMI_kern.04_km.clus7, NMI_kern.04_km.clus8, NMI_kern.04_km.clus10, NMI_kern.04_graph), ncol=2, byrow=F)

colnames(NMIs_kern.04) <- c('Clustering Method','Kernel, 0.04')

NMIs_kern.04_df <- as.data.frame(NMIs_kern.04)

NMIs_kern.04_df
```


```{r}
## SM
SMs_kern.04 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', kern.04.km7.sm$mean_discordant, kern.04.km8.sm$mean_discordant, kern.04.km10.sm$mean_discordant, kern.04.graph.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.04) <- c('Clustering Method', 'Kernel, 0.04')

SMs_kern.04_df <- as.data.frame(SMs_kern.04)

SMs_kern.04_df
```



_______________________________________________________________________
_______________________________________________________________________



#### Method: Kernel , bandwidth = 0.05

```{r, include=FALSE}
# library(smoothclust)

# run smoothclust
spe <- smoothclust(spe1, method = "kernel", bandwidth = 0.05)

assayNames(spe)
```



##### Normalization

```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
assayNames(spe)
```


##### Feature Selection

```{r}
is_mito <- grepl("(^MT-)|(^mt-)", rowData(spe)$gene_name)
spe <- spe[!is_mito, ]

spe_full <- spe

# library(scran)

dec <- modelGeneVar(spe) 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```


##### Dimensionality reduction

```{r}
# Principla Component Analysis
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs, exprs_values = "logcounts")

# UMAP on top 50 PCs -> for visualization
set.seed(123)
spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))
dim(reducedDim(spe, "UMAP"))

# update column names
colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)

# Principal Components for k-means clustering
pcs <- reducedDim(spe, "PCA")
```



##### K-means clustering with 7 centers
```{r}
## 7 centers (one fore each true layer + 1 for white matter)

set.seed(123)

km.7.kern05 <- kmeans(pcs, centers = 7)

table(km.7.kern05$cluster)

# kmeans cluster assignments
km.clus7.kern05 <- km.7.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus7.kern05)
```


###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.05_km7 <- plotSpots(spe, annotate = "label", 
          pal = "Okabe-Ito",
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.05_km7, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.05_km.clus7 <- adjustedRandIndex(colData(spe)$ground_truth,km.clus7.kern05)
ARI_kern.05_km.clus7
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.05_km.clus7 <- NMI(colData(spe)$ground_truth,km.clus7.kern05)
NMI_kern.05_km.clus7
```

###### **Smoothness Metric**

```{r}
kern.05.km7.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.05.km7.sm$mean_discordant
```




##### K-means clustering with 8 centers
```{r}
## 8 centers (one fore each true layer + 2 for white matter)

set.seed(123)

km.8.kern05 <- kmeans(pcs, centers = 8)

table(km.8.kern05$cluster)

# kmeans cluster assignments
km.clus8.kern05 <- km.8.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.kern05)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.05_km8 <- plotSpots(spe, annotate = "label", 
          pal = "Okabe-Ito",
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.05_km8, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.05_km.clus8 <- adjustedRandIndex(colData(spe)$ground_truth, km.clus8.kern05)
ARI_kern.05_km.clus8
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.05_km.clus8 <- NMI(colData(spe)$ground_truth, km.clus8.kern05)
NMI_kern.05_km.clus8
```

###### **Smoothness Metric**

```{r}
kern.05.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.05.km8.sm$mean_discordant
```




##### K-means clustering with 10 centers
```{r}
## 10 centers

set.seed(123)

km.10.kern05 <- kmeans(pcs, centers = 10)

table(km.10.kern05$cluster)

# kmeans cluster assignments
km.clus10.kern05 <- km.10.kern05$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.kern05)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.05_km10 <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.05_km10, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = colors,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = colors,
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.05_km.clus10 <- adjustedRandIndex(colData(spe)$ground_truth, km.clus10.kern05)
ARI_kern.05_km.clus10
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.05_km.clus10 <- NMI(colData(spe)$ground_truth, km.clus10.kern05)
NMI_kern.05_km.clus10
```

###### **Smoothness Metric**

```{r}
kern.05.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.05.km10.sm$mean_discordant
```




##### Graph-based clustering
```{r}
# graph-based clustering
set.seed(123)
k <- 45
g <- buildSNNGraph(spe, k = k,  use.dimred = "PCA")
g_walk <- igraph::cluster_walktrap(g)
g_clus.kern05 <- g_walk$membership
table(g_clus.kern05)

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(g_clus.kern05)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.05_graph <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.05_graph, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = colors,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = colors,
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.05_graph <- adjustedRandIndex(colData(spe)$ground_truth, g_clus.kern05)
ARI_kern.05_graph
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.05_graph <- NMI(colData(spe)$ground_truth, g_clus.kern05)
NMI_kern.05_graph
```

###### **Smoothness Metric**

```{r}
kern.05.graph.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.05.graph.sm$mean_discordant
```




##### SUMMARY

```{r}
## Visualizations
gridExtra::grid.arrange( 
  xyplot_kern.05_km7,
  xyplot_kern.05_km8,
  xyplot_kern.05_km10,
  xyplot_kern.05_graph,
  xyplot_groundtruth,
  ncol=2)
```

```{r}
## ARI
ARIs_kern.05 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', ARI_kern.05_km.clus7, ARI_kern.05_km.clus8, ARI_kern.05_km.clus10, ARI_kern.05_graph), ncol=2, byrow=F)

colnames(ARIs_kern.05) <- c('Clustering Method', 'Kernel, 0.05')

ARIs_kern.05_df <- as.data.frame(ARIs_kern.05)

ARIs_kern.05_df
```


```{r}
## NMI
NMIs_kern.05 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', NMI_kern.05_km.clus7, NMI_kern.05_km.clus8, NMI_kern.05_km.clus10, NMI_kern.05_graph), ncol=2, byrow=F)

colnames(NMIs_kern.05) <- c('Clustering Method', 'Kernel, 0.05')

NMIs_kern.05_df <- as.data.frame(NMIs_kern.05)

NMIs_kern.05_df
```


```{r}
## SM
SMs_kern.05 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', kern.05.km7.sm$mean_discordant, kern.05.km8.sm$mean_discordant, kern.05.km10.sm$mean_discordant, kern.05.graph.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.05) <- c('Clustering Method', 'Kernel, 0.05')

SMs_kern.05_df <- as.data.frame(SMs_kern.05)

SMs_kern.05_df
```


_____________________________________________________________________
_____________________________________________________________________


#### Method: Kernel , bandwidth = 0.1

```{r, include=FALSE}
# library(smoothclust)

# run smoothclust
spe <- smoothclust(spe1, method = "kernel", bandwidth = 0.1)

assayNames(spe)
```



##### Normalization

```{r}
spe <- logNormCounts(spe, assay.type = "counts_smooth") 
assayNames(spe)
```


##### Feature Selection

```{r}
is_mito <- grepl("(^MT-)|(^mt-)", rowData(spe)$gene_name)
spe <- spe[!is_mito, ]

spe_full <- spe

# library(scran)

dec <- modelGeneVar(spe) 
top_hvgs <- getTopHVGs(dec, prop = 0.1)
spe <- spe[top_hvgs, ]
dim(spe)
```



##### Dimensionality reduction

```{r}
# Principal Component Analysis
set.seed(123)
spe <- runPCA(spe, subset_row = top_hvgs, exprs_values = "logcounts")

# UMAP on top 50 PCs -> for visualization
set.seed(123)
spe <-  runUMAP(spe, dimred= "PCA", exprs_values = "logcounts")

dim(reducedDim(spe, "PCA"))
dim(reducedDim(spe, "UMAP"))

# update column names
colnames(reducedDim(spe, "UMAP")) <- paste0("UMAP", 1:2)
```

```{r}
# Principle components for k-means clustering
pcs <- reducedDim(spe, "PCA")
```



##### K-means clustering with 7 centers
```{r}
## 7 centers (one fore each true layer + 1 for white matter)

set.seed(123)

km.7.kern1 <- kmeans(pcs, centers = 7)

table(km.7.kern1$cluster)

# kmeans cluster assignments
km.clus7.kern1 <- km.7.kern1$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus7.kern1)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.1_km7 <- plotSpots(spe, annotate = "label", 
          pal = "Okabe-Ito",
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.1_km7, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.1_km.clus7 <- adjustedRandIndex(colData(spe)$ground_truth,km.clus7.kern1)
ARI_kern.1_km.clus7
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.1_km.clus7 <- NMI(colData(spe)$ground_truth,km.clus7.kern1)
NMI_kern.1_km.clus7
```

###### **Smoothness Metric**

```{r}
kern.1.km7.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.1.km7.sm$mean_discordant
```




##### K-means clustering with 8 centers
```{r}
## 8 centers (one fore each true layer + 2 for white matter)

set.seed(123)

km.8.kern1 <- kmeans(pcs, centers = 8)

table(km.8.kern1$cluster)

# kmeans cluster assignments
km.clus8.kern1 <- km.8.kern1$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus8.kern1)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.1_km8 <- plotSpots(spe, annotate = "label", 
          pal = "Okabe-Ito",
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.1_km8, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = "Okabe-Ito",
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.1_km.clus8 <- adjustedRandIndex(colData(spe)$ground_truth, km.clus8.kern1)
ARI_kern.1_km.clus8
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.1_km.clus8 <- NMI(colData(spe)$ground_truth, km.clus8.kern1)
NMI_kern.1_km.clus8
```

###### **Smoothness Metric**

```{r}
kern.1.km8.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.1.km8.sm$mean_discordant
```




##### K-means clustering with 10 centers
```{r}
## 10 centers

set.seed(123)

km.10.kern1 <- kmeans(pcs, centers = 10)

table(km.10.kern1$cluster)

# kmeans cluster assignments
km.clus10.kern1 <- km.10.kern1$cluster

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(km.clus10.kern1)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.1_km10 <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.1_km10, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = colors,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = colors,
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.1_km.clus10 <- adjustedRandIndex(colData(spe)$ground_truth, km.clus10.kern1)
ARI_kern.1_km.clus10
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.1_km.clus10 <- NMI(colData(spe)$ground_truth, km.clus10.kern1)
NMI_kern.1_km.clus10
```

###### **Smoothness Metric**

```{r}
kern.1.km10.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.1.km10.sm$mean_discordant
```




##### Graph-based clustering
```{r}
# graph-based clustering
set.seed(123)
k <- 45
g <- buildSNNGraph(spe, k = k,  use.dimred = "PCA")
g_walk <- igraph::cluster_walktrap(g)
g_clus.kern1 <- g_walk$membership
table(g_clus.kern1)

# store cluster label in column 'label' in colData
colLabels(spe) <- factor(g_clus.kern1)
```

###### **Visualization**

```{r}
# plot clusters in spatial x-y coordinates
xyplot_kern.1_graph <- plotSpots(spe, annotate = "label", 
          pal = colors,
          point_size = 0.7)
gridExtra::grid.arrange(xyplot_kern.1_graph, xyplot_groundtruth, ncol=2)
```


*Reduced Dimensionality Cluster Visualization*
```{r}
# plot clusters in PCA reduced dimensions
plotDimRed(spe, plot_type = "PCA", 
           annotate = "label", pal = colors,
           point_size = 0.7)

# plot clusters in UMAP reduced dimensions
plotDimRed(spe, plot_type = "UMAP", 
           annotate = "label", pal = colors,
           point_size = 0.7)
```


###### **Adjusted Rand Index**

```{r}
# library(mclust)
ARI_kern.1_graph <- adjustedRandIndex(colData(spe)$ground_truth, g_clus.kern1)
ARI_kern.1_graph
```

###### **Normalized Mutual Information**

```{r}
# library(randnet)
NMI_kern.1_graph <- NMI(colData(spe)$ground_truth, g_clus.kern1)
NMI_kern.1_graph
```

###### **Smoothness Metric**

```{r}
kern.1.graph.sm <- smoothness_metric(spatial_coords = spatialCoords(spe), labels = as.numeric(colData(spe)$label), k=6)

kern.1.graph.sm$mean_discordant
```




##### SUMMARY

```{r}
## Visualizations
gridExtra::grid.arrange( 
  xyplot_kern.1_km7,
  xyplot_kern.1_km8,
  xyplot_kern.1_km10,
  xyplot_kern.1_graph,
  xyplot_groundtruth,
  ncol=2)
```


```{r}
## ARI
ARIs_kern.1 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', ARI_kern.1_km.clus7, ARI_kern.1_km.clus8, ARI_kern.1_km.clus10, ARI_kern.1_graph), ncol=2, byrow=F)

colnames(ARIs_kern.1) <- c('Clustering Method', 'Kernel, 0.1')

ARIs_kern.1_df <- as.data.frame(ARIs_kern.1)

ARIs_kern.1_df
```


```{r}
## NMI
NMIs_kern.1 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', NMI_kern.1_km.clus7, NMI_kern.1_km.clus8, NMI_kern.1_km.clus10, NMI_kern.1_graph), ncol=2, byrow=F)

colnames(NMIs_kern.1) <- c('Clustering Method', 'Kernel, 0.1')

NMIs_kern.1_df <- as.data.frame(NMIs_kern.1)

NMIs_kern.1_df
```


```{r}
## SM
SMs_kern.1 <- matrix(c('kmeans (7 clusters)','kmeans (8 clusters)','kmeans (10 clusters)','graph-based', kern.1.km7.sm$mean_discordant, kern.1.km8.sm$mean_discordant, kern.1.km10.sm$mean_discordant, kern.1.graph.sm$mean_discordant), ncol=2, byrow=F)

colnames(SMs_kern.1) <- c('Clustering Method', 'Kernel, 0.1')

SMs_kern.1_df <- as.data.frame(SMs_kern.1)

SMs_kern.1_df
```


_________________________________________________________________________
_________________________________________________________________________


### DLPFC Quantitative Metrics Summary

#### ARIs

```{r}
aris_list <- list(ARIs_nonspac_df, ARIs_uni_df, ARIs_kern.02_df, ARIs_kern.04_df, ARIs_kern.05_df, ARIs_kern.1_df)
ARI_DLPFC <- Reduce(function(x, y) merge(x, y, ), aris_list)

cols <- c(2:7)
ARI_DLPFC[ , cols] <- apply(ARI_DLPFC[ , cols,drop=F], 2,           
                    function(x) as.numeric(as.character(x)))

is.num <- sapply(ARI_DLPFC, is.numeric)
ARI_DLPFC[is.num] <- lapply(ARI_DLPFC[is.num], round, 4)

ARI_DLPFC
```

#### NMIs

```{r}
NMIs_list <- list(NMIs_nonspac_df, NMIs_uni_df, NMIs_kern.02_df, NMIs_kern.04_df, NMIs_kern.05_df, NMIs_kern.1_df)
NMI_DLPFC <- Reduce(function(x, y) merge(x, y, ), NMIs_list)

cols <- c(2:7)
NMI_DLPFC[ , cols] <- apply(NMI_DLPFC[ , cols,drop=F], 2,           
                    function(x) as.numeric(as.character(x)))

is.num <- sapply(NMI_DLPFC, is.numeric)
NMI_DLPFC[is.num] <- lapply(NMI_DLPFC[is.num], round, 4)

NMI_DLPFC
```


#### Smoothness Metrics

```{r}
SMs_list <- list(SMs_nonspac_df, SMs_uni_df, SMs_kern.02_df, SMs_kern.04_df, SMs_kern.05_df, SMs_kern.1_df)
SM_DLPFC <- Reduce(function(x, y) merge(x, y, ), SMs_list)

cols <- c(2:7)
SM_DLPFC[ , cols] <- apply(SM_DLPFC[ , cols,drop=F], 2,           
                    function(x) as.numeric(as.character(x)))

is.num <- sapply(SM_DLPFC, is.numeric)
SM_DLPFC[is.num] <- lapply(SM_DLPFC[is.num], round, 4)

SM_DLPFC
```



### Compositional Analysis

```{r}
library(reshape)
```


#### Uniform 

##### 8 Smoothclust Clusters

*10 Nonspatial clusters*
```{r}
length(km.clus8.uni)
length(km.clus10.nonspac)

# check cluster frequencies
table(km.clus8.uni)
table(km.clus10.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus8.uni))
kmeans_labels <- sort(unique(km.clus10.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus8.uni)
kmeans_clus <- as.factor(km.clus10.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}
res
rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
df
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_fill_manual(values=colors) +
  scale_x_continuous(breaks=c(1:8)) +
  theme_bw()
```


```{r}
gridExtra::grid.arrange(
  (xyplot_uni_km8 + labs(title="Spatial - uniform")),
  (xyplot_nonspac_km10 + labs(title="Non-spatial")),
  ncol=2)
```

#### Kernel, 0.02

*10 Nonspatial clusters*
```{r}
length(km.clus8.kern02)
length(km.clus10.nonspac)

# check cluster frequencies
table(km.clus8.kern02)
table(km.clus10.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus8.kern02))
kmeans_labels <- sort(unique(km.clus10.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus8.kern02)
kmeans_clus <- as.factor(km.clus10.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}
res
rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
df
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_fill_manual(values=colors) +
  scale_x_continuous(breaks=c(1:8)) +
  theme_bw()
```


```{r}
gridExtra::grid.arrange(
  (xyplot_kern.02_km8 + labs(title="Spatial - uniform")),
  (xyplot_nonspac_km10 + labs(title="Non-spatial")),
  ncol=2)
```

#### Kernel, 0.04

*10 Nonspatial clusters*
```{r}
length(km.clus8.kern04)
length(km.clus10.nonspac)

# check cluster frequencies
table(km.clus8.kern04)
table(km.clus10.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus8.kern04))
kmeans_labels <- sort(unique(km.clus10.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus8.kern04)
kmeans_clus <- as.factor(km.clus10.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}
res
rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
df
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_fill_manual(values=colors) +
  scale_x_continuous(breaks=c(1:8)) +
  theme_bw()
```


```{r}
gridExtra::grid.arrange(
  (xyplot_kern.04_km8 + labs(title="Spatial - uniform")),
  (xyplot_nonspac_km10 + labs(title="Non-spatial")),
  ncol=2)
```


#### Kernel, 0.05

*10 Nonspatial clusters*
```{r}
length(km.clus8.kern05)
length(km.clus10.nonspac)

# check cluster frequencies
table(km.clus8.kern05)
table(km.clus10.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus8.kern05))
kmeans_labels <- sort(unique(km.clus10.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus8.kern05)
kmeans_clus <- as.factor(km.clus10.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}
res
rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
df
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_fill_manual(values=colors) +
  scale_x_continuous(breaks=c(1:8)) +
  theme_bw()
```


```{r}
gridExtra::grid.arrange(
  (xyplot_kern.05_km8 + labs(title="Spatial - uniform")),
  (xyplot_nonspac_km10 + labs(title="Non-spatial")),
  ncol=2)
```



#### Kernel, 0.1

*10 Nonspatial clusters*
```{r}
length(km.clus8.kern1)
length(km.clus10.nonspac)

# check cluster frequencies
table(km.clus8.kern1)
table(km.clus10.nonspac)
```


```{r}
# get cluster labels
smoothclust_labels <- sort(unique(km.clus8.kern1))
kmeans_labels <- sort(unique(km.clus10.nonspac))

smoothclust_labels
kmeans_labels
```


```{r}
# create empty matrix to store results
res <- matrix(
  NA, 
  nrow = length(smoothclust_labels), 
  ncol = length(kmeans_labels)
)

rownames(res) <- paste0("smoothclust_", smoothclust_labels)
colnames(res) <- paste0("kmeans_", kmeans_labels)

# convert vectors of cluster labels to factors so empty levels are not dropped when subsetting
smoothclust_clus <- as.factor(km.clus8.kern1)
kmeans_clus <- as.factor(km.clus10.nonspac)

# calculate by row (i.e. for each smoothclust domain)
for (i in 1:nrow(res)) {
  # subset k-means cluster labels for points in smoothclust domain i
  kmeans_sub <- kmeans_clus[smoothclust_clus == smoothclust_labels[i]]
  # calculate frequency table
  kmeans_sub_tbl <- table(kmeans_sub)
  # convert frequency table to proportions and store in matrix
  res[i, ] <- kmeans_sub_tbl / sum(kmeans_sub_tbl)
}
res
rowSums(res)
```

```{r}
df <- melt(cbind(smoothclust_labels, as.data.frame(res)), id.vars = "smoothclust_labels")
df
```


```{r}
# then create stacked bar plot
ggplot(df, aes(x=smoothclust_labels, y=value, fill=variable)) +
  geom_bar(stat="identity") +
  labs(y="Proportion of Nonspatial Cluster", 
       x="Smoothclust Cluster",
       title = "Proportion of nonspatital k means cluster spots \nwithin a smoothclust region") +
  scale_fill_manual(values=colors) +
  scale_x_continuous(breaks=c(1:8)) +
  theme_bw()
```


```{r}
gridExtra::grid.arrange(
  (xyplot_kern.1_km8 + labs(title="Spatial - uniform")),
  (xyplot_nonspac_km10 + labs(title="Non-spatial")),
  ncol=2)
```


